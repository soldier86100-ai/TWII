import streamlit as st
import yfinance as yf
import pandas as pd
import plotly.graph_objects as go
import datetime

st.set_page_config(layout="wide", page_title="Taiwan Stock Pro Dashboard")

# ==========================================
# 1. 核心數據定義 (台股產業分類與名稱對照)
# ==========================================

# 1. 產業分類清單 (Source: Your File)
RAW_SECTOR_DATA = {
    'DRAM製造': ['2342', '2344', '2408', '3260', '4967', '5289', '5347', '8088', '8271', '8277'],
    '水泥': ['1101', '1102', '1103', '1104', '1108', '1109', '1110'],
    '食品業': ['1210', '1215', '1216', '1218', '1219', '1225', '1227', '1229', '1231', '1232', '1233', '1234', '1236', '1702', '1737'],
    '肉品加工': ['1213', '1256'],
    '塑膠業': ['1301', '1303', '1304', '1305', '1307', '1308', '1309', '1310', '1312', '1313', '1314', '1315', '1321', '1323', '1324', '1325', '1326', '1337', '1340', '1341', '1342', '4306'],
    '聚乙烯PE': ['1301', '1304', '1308', '1323'],
    '聚氯乙烯PVC': ['1301', '1304', '1305', '1312', '1323'],
    '聚丙烯PP': ['1303', '1304', '1314', '1326', '1704'],
    '聚苯乙烯PS': ['1303', '1310', '1312', '1314'],
    'ABS樹脂': ['1303', '1309', '1310', '1312'],
    '可塑劑DOP': ['1312', '1313'],
    '苯乙烯SM': ['1310', '1314'],
    'CPL、AN': ['1314'],
    '合成皮': ['1301', '1303', '1315'],
    '紡纖業': ['1402', '1409', '1410', '1413', '1414', '1416', '1417', '1418', '1419', '1423', '1432', '1434', '1435', '1436', '1437', '1438', '1439', '1440', '1441', '1442', '1443', '1444', '1445', '1446', '1447', '1449', '1451', '1452', '1453', '1454', '1455', '1456', '1457', '1459', '1460', '1463', '1464', '1465', '1466', '1467', '1468', '1470', '1471', '1472', '1473', '1474', '1475', '1476', '1477', '2929', '4414', '4426', '4438'],
    '化纖原料': ['1409', '1417', '1444', '1455', '1710'],
    '聚酯粒、棉、絲': ['1402', '1409', '1416', '1417', '1423', '1434', '1440', '1442', '1444', '1446', '1447', '1452', '1453', '1454', '1455', '1457', '1459', '1460', '1463', '1464', '1466', '1471', '1472', '2929'],
    '加工絲': ['1409', '1417', '1444', '1447', '1452', '1453', '1454', '1455', '1456', '1459', '1464', '1466', '1471'],
    '羊毛': ['1413', '1435', '1437'],
    '亞克力棉': ['1451'],
    '電機機械': ['1503', '1504', '1506', '1507', '1512', '1513', '1514', '1515', '1516', '1517', '1519', '1521', '1522', '1524', '1525', '1526', '1527', '1528', '1529', '1530', '1531', '1532', '1533', '1535', '1536', '1537', '1538', '1539', '1540', '1541', '1558', '1560', '1568', '1582', '1583', '1589', '1590', '1592', '1597', '2049', '2228', '2231', '2233', '2236', '2239', '2241', '2243', '2247', '3162', '4503', '4506', '4510', '4513', '4523', '4526', '4527', '4528', '4529', '4530', '4532', '4533', '4534', '4535', '4536', '4540', '4541', '4542', '4543', '4545', '4549', '4550', '4551', '4552', '4554', '4555', '4556', '4557', '4560', '4561', '4562', '4563', '4564', '4566', '4569', '4571', '4572', '4573', '4576', '4577', '4578', '4581', '4583', '4588', '5288', '6603', '6609', '8027', '8222', '8234', '8255', '8374', '8996'],
    '家電': ['1503', '1504', '1506', '1507', '1605', '1609', '1612', '1615', '1616', '2430'],
    '電機': ['1503', '1504', '1513', '1514', '1519'],
    '零件': ['1506', '1512', '1516', '1517', '1521', '1522', '1524', '1525', '1527', '1528', '1533', '1536', '1538', '1539', '1540', '1541', '2239'],
    '機械': ['1515', '1526', '1529', '1530', '1531', '1532', '1535', '1537', '1582', '1583', '1590', '1597', '4526', '4532', '4533', '4540'],
    '電器電纜': ['1603', '1605', '1608', '1609', '1611', '1612', '1614', '1615', '1616', '1617', '1618', '1626'],
    '化工業': ['1701', '1702', '1704', '1707', '1708', '1709', '1710', '1711', '1712', '1713', '1714', '1717', '1718', '1720', '1721', '1722', '1723', '1724', '1725', '1726', '1727', '1730', '1731', '1732', '1733', '1734', '1735', '1736', '1737', '1742', '1752', '1760', '1762', '1773', '1776', '1783', '1786', '1795', '1799', '3708', '4702', '4706', '4707', '4711', '4712', '4714', '4716', '4720', '4721', '4722', '4725', '4726', '4728', '4729', '4733', '4734', '4738', '4739', '4741', '4743', '4744', '4745', '4746', '4747', '4754', '4755', '4760', '4763', '4764', '4766', '4767', '4768', '4770', '4771', '5234', '6509', '6664', '6799', '7756', '8342'],
    '玻璃陶瓷': ['1802', '1805', '1806', '1808', '1809', '1810', '1817'],
    '造紙業': ['1903', '1904', '1905', '1906', '1907', '1909'],
    '鋼鐵業': ['2002', '2006', '2007', '2008', '2009', '2010', '2012', '2013', '2014', '2015', '2017', '2020', '2022', '2023', '2024', '2025', '2027', '2028', '2029', '2030', '2031', '2032', '2033', '2034', '2035', '2038', '2059', '2063', '2064', '2065', '2069', '2070', '2072', '2073', '2211', '5007', '5009', '5011', '5013', '5014', '5015', '5016', '5536', '8349', '9958', '9962'],
    '橡膠業': ['2101', '2102', '2103', '2104', '2105', '2106', '2107', '2108', '2109', '2114', '2115', '6582'],
    '汽車業': ['2201', '2204', '2206', '2207', '2208', '2227', '2250'],
    '營建業': ['1438', '1442', '1453', '1805', '1808', '2501', '2504', '2505', '2506', '2509', '2511', '2514', '2515', '2516', '2520', '2524', '2527', '2528', '2530', '2534', '2535', '2536', '2537', '2538', '2539', '2540', '2542', '2543', '2545', '2546', '2547', '2548', '2597', '2841', '2923', '5508', '5511', '5512', '5514', '5515', '5516', '5519', '5520', '5521', '5522', '5523', '5525', '5529', '5530', '5531', '5533', '5534', '5543', '5546', '6171', '9906', '9946'],
    '運輸業': ['2208', '2601', '2603', '2605', '2606', '2607', '2608', '2609', '2610', '2611', '2612', '2613', '2614', '2615', '2616', '2617', '2618', '2630', '2633', '2634', '2636', '2637', '2640', '2641', '2642', '2643', '2645', '2646', '5601', '5603', '5604', '5607', '5608', '5609', '8367'],
    '觀光業': ['2701', '2702', '2704', '2705', '2706', '2707', '2712', '2718', '2719', '2722', '2723', '2724', '2727', '2729', '2731', '2732', '2734', '2736', '2739', '2740', '2743', '2745', '2748', '2752', '2753', '2754', '2755', '2756', '5701', '5703', '5704', '5706', '8940', '9943'],
    '金融保險': ['2801', '2809', '2812', '2816', '2820', '2823', '2832', '2834', '2836', '2838', '2845', '2849', '2850', '2851', '2852', '2855', '2867', '2880', '2881', '2882', '2883', '2884', '2885', '2886', '2887', '2888', '2889', '2890', '2891', '2892', '2897', '5864', '5876', '5878', '5880', '6005', '6023', '6024', '6026'],
    '百貨貿易': ['2901', '2903', '2904', '2905', '2906', '2908', '2910', '2911', '2912', '2913', '2915', '2916', '2926', '2936', '2937', '2939', '5903', '5904', '5905', '5906', '5907', '6733', '8403', '8428', '8433', '8455', '9960'],
    '清潔用品': ['1702', '1737'],
    '生化製藥': ['1701', '1707', '1720', '1729', '1731', '1733', '1734', '1736', '1760', '1762', '1795', '3118', '3164', '3176', '3705', '4102', '4104', '4105', '4106', '4108', '4109', '4111', '4114', '4116', '4119', '4120', '4121', '4123', '4126', '4127', '4128', '4129', '4130', '4133', '4137', '4138', '4141', '4142', '4144', '4147', '4148', '4152', '4153', '4154', '4155', '4157', '4160', '4161', '4162', '4163', '4164', '4167', '4168', '4169', '4170', '4171', '4173', '4174', '4175', '4180', '4183', '4190', '4192', '4198', '4726', '4728', '4738', '4743', '4746', '6446', '6461', '6469', '6472', '6492', '6496', '6499', '6517', '6523', '6535', '6541', '6547', '6550', '6569', '6574', '6576', '6586', '6589', '6612', '6615', '6641', '6657', '6679', '6703', '6712', '6732', '6743', '6747', '6762', '6781', '6788', '6794', '6846', '6855', '6865', '6866', '6869', '6903'],
    '樹脂': ['1301', '1303', '1305', '1309', '1312', '1314', '1326', '1704', '1714'],
    '醫療品與通路': ['1701', '1707', '1713', '1720', '1731', '1733', '1734', '1736', '1783', '1799', '3218', '4104', '4106', '4107', '4113', '4138', '4139', '4154', '4161', '4163', '4167', '4171', '4173', '4175', '4180', '4728', '4734', '4745', '6130', '6509', '6653'],
    '農藥肥料': ['1708', '1722', '1723', '1727', '1730', '6508'],
    '膠、膠帶': ['1324', '1727', '2101', '2105', '2108'],
    '紙漿': ['1905', '1906'],
    '工業用紙': ['1903', '1904', '1906', '1907', '1909'],
    '文化用紙': ['1904', '1905', '1906', '1907'],
    '家庭用紙': ['1904', '1906'],
    '盤元線材': ['2006', '2010', '2012', '2022', '2028', '2033', '2064', '2211', '5009', '9958'],
    '鋼筋': ['2006', '2015', '2017', '2020', '2028', '2035', '2038', '5007', '5009', '5536'],
    '鋼板': ['2002', '2008', '2010', '2023', '2025', '2029', '2031'],
    '熱軋鋼捲': ['2002', '2008', '2010', '2014', '2023', '2029'],
    '鋼結構': ['2007', '2009', '2013', '2024', '2025', '2063', '5536', '9962'],
    '鋼管': ['2014', '2020', '2027', '2029', '2030', '2031', '2034', '5015', '5016'],
    '冷軋鋼捲': ['2002', '2008', '2009', '2010', '2023', '2029', '9958'],
    '鍍鋅鋼捲': ['2002', '2008', '2009', '2010', '2023', '2029', '9958'],
    '不鏽鋼': ['2008', '2010', '2025', '2027', '2030', '2031', '2032', '2033', '2034', '2069', '5009', '5013', '5014', '5016', '8349', '9958', '9962'],
    '鍍烤鋅鋼品': ['2008', '2009', '2010', '2023', '2029', '9958'],
    '非鐵金屬': ['1605', '2009', '9927'],
    '輪胎': ['2102', '2103', '2104', '2105', '2106', '2107', '2108', '2109'],
    '其他橡膠': ['2101', '2114', '2115'],
    '汽車': ['2201', '2204', '2207', '2227'],
    '機車': ['2206', '2208'],
    '營造': ['2501', '2505', '2511', '2515', '2524', '2535', '2546', '2548', '5511', '5519', '5521', '5530', '5531', '5534', '5543', '9906'],
    '營建': ['1438', '1442', '1453', '1805', '1808', '2501', '2504', '2505', '2506', '2509', '2514', '2516', '2520', '2524', '2527', '2528', '2530', '2534', '2536', '2537', '2538', '2539', '2540', '2542', '2543', '2545', '2547', '2597', '2841', '2923', '5508', '5512', '5515', '5516', '5522', '5523', '5525', '5529', '5533', '5546', '9946'],
    '空運': ['2610', '2618', '2634', '2645', '2646', '5609'],
    '散裝航運': ['2601', '2605', '2606', '2612', '2614', '2617', '2637', '2641', '2642', '5601', '5608'],
    '貨櫃航運': ['2603', '2609', '2615'],
    '陸運': ['2607', '2608', '2616', '2633', '2636', '2640', '2643', '5603', '5604', '8367'],
    '倉儲貨櫃場': ['2607', '2611', '2613', '5607'],
    '金控': ['2880', '2881', '2882', '2883', '2884', '2885', '2886', '2887', '2888', '2889', '2890', '2891', '2892', '5880'],
    '銀行': ['2801', '2809', '2812', '2834', '2836', '2838', '2845', '2849', '2850', '2851', '2852', '2897', '5876'],
    '證金票券': ['2816', '2820', '2855', '2889', '6023', '6024'],
    '保險': ['2823', '2832', '2852', '2867', '5864', '5878', '6026'],
    '百貨零售': ['2901', '2903', '2905', '2908', '2910', '2911', '2912', '2913', '2915', '2926', '2936', '2939', '5903', '5904', '5905', '5906', '5907', '6733', '8403', '8428', '8433', '8455', '9960'],
    '貿易': ['2904', '2906', '2916', '2937'],
    '其他': ['1439', '1526', '2012', '2107', '2250', '2348', '2424', '2443', '2468', '2477', '2488', '2496', '2514', '2630', '2841', '2923', '3029', '3152', '4123', '4129', '4137', '4148', '5283', '5301', '5314', '5483', '5514', '5520', '5820', '5876', '5878', '6103', '6139', '6171', '6184', '6191', '6198', '6199', '6264', '6404', '6482', '6485', '6561', '6624', '6670', '6691', '6806', '6807', '6829', '6873', '6933', '6937', '7634', '8033', '8040', '8299', '8404', '8410', '8415', '8416', '8418', '8420', '8421', '8422', '8423', '8424', '8426', '8429', '8431', '8432', '8435', '8436', '8437', '8440', '8444', '8446', '8450', '8454', '8462', '8463', '8464', '8466', '8467', '8472', '8473', '8476', '8477', '8478', '8480', '8481', '8482', '8488', '8489', '8497', '8499', '8905', '8906', '8913', '8916', '8924', '8926', '8927', '8928', '8930', '8931', '8932', '8933', '8935', '8936', '8937', '8938', '8942', '9902', '9904', '9905', '9907', '9908', '9910', '9911', '9912', '9914', '9917', '9918', '9919', '9921', '9924', '9925', '9926', '9927', '9928', '9929', '9930', '9931', '9933', '9934', '9935', '9937', '9938', '9939', '9940', '9941', '9942', '9944', '9945', '9950', '9951', '9955', '9962'],
    '自行車': ['5306', '8928', '8930', '8932', '8933', '9914', '9921'],
    '公用事業': ['1514', '2613', '8341', '8401', '8411', '8422', '8437', '8478', '8905', '8908', '8917', '8923', '8926', '8927', '8931', '9902', '9908', '9917', '9918', '9931', '9933', '9937'],
    '文化傳播事業': ['5203', '6101', '6111', '6165', '6183', '8446', '8450', '8923', '9905', '9930'],
    '鞋業': ['8404', '9802', '9904', '9910', '9938'],
    '保全': ['9917', '9925'],
    '消費性電子': ['2301', '2302', '2303', '2305', '2308', '2312', '2313', '2314', '2316', '2317', '2321', '2323', '2324', '2328', '2329', '2330', '2331', '2337', '2338', '2340', '2342', '2344', '2345', '2347', '2348', '2349', '2351', '2352', '2353', '2354', '2355', '2356', '2357', '2358', '2359', '2360', '2362', '2363', '2364', '2365', '2367', '2368', '2369', '2371', '2373', '2374', '2375', '2376', '2377', '2379', '2380', '2382', '2383', '2385', '2387', '2388', '2390', '2392', '2393', '2395', '2397', '2399', '2401', '2402', '2404', '2405', '2406', '2408', '2409', '2412', '2413', '2414', '2415', '2417', '2419', '2420', '2421', '2423', '2424', '2425', '2426', '2427', '2428', '2429', '2430', '2431', '2433', '2434', '2436', '2438', '2439', '2440', '2441', '2442', '2443', '2444', '2449', '2450', '2451', '2453', '2454', '2455', '2456', '2457', '2458', '2459', '2460', '2461', '2462', '2464', '2465', '2466', '2467', '2468', '2471', '2472', '2474', '2476', '2477', '2478', '2480', '2481', '2482', '2483', '2484', '2485', '2486', '2488', '2489', '2491', '2492', '2493', '2495', '2496', '2497', '2498', '3002', '3003', '3004', '3005', '3006', '3008', '3010', '3011', '3013', '3014', '3015', '3016', '3017', '3018', '3019', '3021', '3022', '3023', '3024', '3025', '3026', '3027', '3028', '3029', '3030', '3031', '3032', '3033', '3034', '3035', '3036', '3037', '3038', '3040', '3041', '3042', '3043', '3044', '3045', '3046', '3047', '3048', '3049', '3050', '3051', '3052', '3054', '3055', '3056', '3057', '3058', '3059', '3060', '3062', '3090', '3092', '3094', '3128', '3130', '3149', '3167', '3189', '3209', '3211', '3213', '3217', '3224', '3227', '3228', '3230', '3231', '3234', '3236', '3252', '3257', '3260', '3264', '3265', '3266', '3272', '3284', '3285', '3287', '3289', '3290', '3293', '3294', '3296', '3297', '3303', '3305', '3306', '3308', '3310', '3311', '3312', '3313', '3315', '3317', '3321', '3322', '3323', '3324', '3325', '3332', '3338', '3339', '3346', '3354', '3356', '3360', '3362', '3363', '3372', '3373', '3374', '3376', '3379', '3380', '3383', '3388', '3390', '3402', '3406', '3413', '3416', '3419', '3432', '3437', '3438', '3441', '3443', '3444', '3450', '3454', '3455', '3465', '3466', '3479', '3481', '3483', '3484', '3490', '3491', '3494', '3498', '3499', '3501', '3504', '3508', '3511', '3512', '3515', '3516', '3518', '3520', '3521', '3522', '3523', '3526', '3527', '3528', '3529', '3530', '3531', '3532', '3533', '3535', '3536', '3537', '3540', '3541', '3543', '3545', '3546', '3548', '3550', '3551', '3552', '3555', '3556', '3558', '3559', '3563', '3564', '3567', '3570', '3576', '3577', '3580', '3581', '3583', '3587', '3588', '3591', '3592', '3593', '3594', '3596', '3605', '3607', '3609', '3611', '3615', '3617', '3622', '3623', '3624', '3625', '3628', '3630', '3631', '3632', '3642', '3645', '3646', '3652', '3653', '3661', '3663', '3664', '3665', '3666', '3669', '3673', '3675', '3679', '3680', '3682', '3684', '3685', '3686', '3687', '3689', '3691', '3693', '3694', '3698', '3701', '3702', '3703', '3704', '3706', '3707', '3709', '3710', '3711', '3712', '3713', '3714', '3715', '4542', '4904', '4905', '4906', '4908', '4909', '4911', '4912', '4915', '4916', '4919', '4923', '4924', '4927', '4930', '4933', '4934', '4935', '4938', '4939', '4942', '4943', '4944', '4945', '4946', '4952', '4953', '4956', '4958', '4960', '4961', '4966', '4967', '4968', '4971', '4972', '4973', '4974', '4976', '4977', '4979', '4987', '4991', '4994', '4995', '4999', '5201', '5202', '5209', '5210', '5211', '5212', '5213', '5215', '5220', '5222', '5223', '5225', '5227', '5230', '5234', '5236', '5243', '5244', '5245', '5248', '5251', '5258', '5263', '5269', '5272', '5274', '5276', '5278', '5281', '5284', '5285', '5287', '5288', '5289', '5291', '5299', '5309', '5310', '5312', '5315', '5321', '5324', '5328', '5340', '5344', '5345', '5347', '5348', '5351', '5353', '5355', '5356', '5371', '5381', '5383', '5386', '5388', '5392', '5398', '5403', '5410', '5425', '5426', '5432', '5434', '5438', '5439', '5443', '5450', '5452', '5455', '5457', '5460', '5464', '5465', '5468', '5469', '5471', '5474', '5475', '5478', '5481', '5484', '5487', '5488', '5489', '5490', '5493', '5498', '5536', '6104', '6105', '6108', '6109', '6112', '6113', '6114', '6115', '6116', '6117', '6118', '6120', '6121', '6122', '6123', '6124', '6125', '6126', '6127', '6128', '6129', '6131', '6133', '6134', '6136', '6138', '6140', '6141', '6142', '6143', '6144', '6146', '6147', '6148', '6150', '6151', '6152', '6153', '6154', '6155', '6156', '6158', '6160', '6161', '6163', '6164', '6166', '6167', '6168', '6169', '6170', '6173', '6174', '6175', '6176', '6177', '6179', '6180', '6182', '6185', '6186', '6187', '6188', '6189', '6190', '6192', '6194', '6195', '6196', '6197', '6201', '6202', '6203', '6204', '6205', '6206', '6207', '6208', '6209', '6210', '6213', '6214', '6215', '6216', '6217', '6218', '6219', '6220', '6221', '6223', '6224', '6225', '6226', '6227', '6228', '6229', '6230', '6231', '6233', '6234', '6235', '6236', '6237', '6239', '6240', '6242', '6243', '6244', '6245', '6246', '6247', '6248', '6251', '6257', '6259', '6261', '6263', '6265', '6266', '6269', '6270', '6271', '6274', '6275', '6276', '6277', '6278', '6279', '6281', '6282', '6283', '6284', '6285', '6287', '6288', '6289', '6290', '6291', '6292', '6294', '6298', '6405', '6409', '6411', '6412', '6414', '6415', '6416', '6417', '6418', '6422', '6426', '6431', '6432', '6435', '6438', '6441', '6442', '6449', '6451', '6456', '6457', '6462', '6465', '6470', '6477', '6486', '6488', '6491', '6494', '6504', '6506', '6510', '6512', '6514', '6515', '6516', '6525', '6527', '6531', '6532', '6533', '6538', '6542', '6548', '6552', '6558', '6560', '6568', '6570', '6573', '6577', '6578', '6579', '6588', '6590', '6591', '6593', '6594', '6605', '6606', '6613', '6616', '6625', '6629', '6640', '6642', '6643', '6651', '6666', '6667', '6668', '6669', '6671', '6672', '6674', '6683', '6690', '6693', '6695', '6697', '6698', '6706', '6715', '6716', '6719', '6727', '6728', '6730', '6741', '6751', '6752', '6753', '6754', '6756', '6761', '6763', '6768', '6770', '6776', '6782', '6789', '6791', '6792', '6796', '6803', '6805', '6811', '6821', '6830', '6834', '6841', '6854', '6859', '6861', '6863', '6874', '6901', '6902', '6908', '6913', '6914', '6928', '6934', '6949', '6969', '8011', '8016', '8021', '8024', '8028', '8032', '8034', '8038', '8039', '8042', '8043', '8044', '8046', '8047', '8048', '8049', '8050', '8054', '8059', '8064', '8066', '8067', '8068', '8069', '8070', '8071', '8072', '8074', '8076', '8077', '8080', '8081', '8083', '8084', '8085', '8086', '8087', '8088', '8089', '8091', '8092', '8093', '8096', '8097', '8099', '8101', '8103', '8104', '8105', '8107', '8109', '8110', '8111', '8112', '8114', '8121', '8131', '8147', '8150', '8155', '8163', '8171', '8176', '8182', '8183', '8201', '8210', '8213', '8215', '8227', '8234', '8240', '8249', '8255', '8261', '8271', '8277', '8279', '8287', '8289', '8291', '8358', '8383', '8390', '9911', '9912'],
    '數位相機': ['2360', '2406', '3019', '3050', '3059', '3362', '3413', '3441', '3504', '4915', '4976', '5348', '5371', '5478', '6120', '6206', '6209', '8050'],
    '量測儀器': ['2360', '3289', '3628', '6131', '6163', '6182', '6223', '6245'],
    '輸入設備': ['2324', '2365', '2380', '2385', '2387', '2425', '2440', '3230', '3297', '3390', '3570', '4935', '5215', '5478', '6121', '6233', '6244', '6276', '8050'],
    '揚聲器': ['2402', '2439', '3003', '3024', '4916', '5215', '5490', '6208', '6679'],
    '其他元件': ['1582', '2059', '2328', '2355', '2404', '2413', '2415', '2417', '2419', '2420', '2428', '2429', '2431', '2433', '2434', '2436', '2456', '2457', '2462', '2467', '2472', '2476', '2483', '2484', '2488', '2497', '3003', '3015', '3026', '3032', '3037', '3046', '3048', '3051', '3058', '3090', '3092', '3209', '3217', '3224', '3227', '3285', '3289', '3294', '3303', '3308', '3313', '3321', '3322', '3339', '3432', '3467', '3484', '3511', '3597', '3646', '4923', '4989', '4999', '5222', '6124', '6174', '6175', '6207', '6208', '6290', '6417', '6432', '6693', '6761', '6770', '6792', '8033', '8040', '8048', '8111', '8114'],
    '電感': ['2428', '2436', '2456', '2472', '2484', '3227', '3313', '6127', '6155'],
    '光學元件': ['2374', '2409', '2461', '2467', '3008', '3019', '3031', '3038', '3049', '3050', '3051', '3059', '3362', '3406', '3441', '3504', '3508', '3630', '4915', '4976', '5348', '5371', '5443', '6120', '6209', '6224', '8050', '8105'],
    '變壓器': ['2328', '2413', '2420', '2431', '3046', '3209', '3321', '6155', '8040'],
    '電池': ['1536', '1537', '1611', '1723', '2308', '2355', '2434', '3043', '3211', '3227', '3323', '3416', '3615', '3625', '4721', '4739', '4934', '5227', '6121', '6509', '8038', '8215'],
    '工業電腦': ['2308', '2351', '2395', '2414', '3014', '3022', '3416', '3479', '3577', '4916', '5258', '6105', '6128', '6140', '6153', '6160', '6166', '6196', '6208', '6245', '6414', '6579', '8050', '8110', '8114', '8234']
}

# 2. 股票名稱對照表 (Code -> Name)
STOCK_NAMES = {
    '2342': '茂矽',
    '2344': '華邦電',
    '2408': '南亞科',
    '3260': '威剛',
    '4967': '十銓',
    '5289': '宜鼎',
    '5347': '世界',
    '8088': '品安',
    '8271': '宇瞻',
    '8277': '商丞',
    '1101': '台泥',
    '1102': '亞泥',
    '1103': '嘉泥',
    '1104': '環泥',
    '1108': '幸福',
    '1109': '信大',
    '1110': '東泥',
    '1210': '大成',
    '1215': '卜蜂',
    '1216': '統一',
    '1218': '泰山',
    '1219': '福壽',
    '1225': '福懋油',
    '1227': '佳格',
    '1229': '聯華',
    '1231': '聯華食',
    '1232': '大統益',
    '1233': '天仁',
    '1234': '黑松',
    '1236': '宏亞',
    '1702': '南僑',
    '1737': '臺鹽',
    '1213': '大飲',
    '1256': '鮮活果汁-KY',
    '1301': '台塑',
    '1303': '南亞',
    '1304': '台聚',
    '1305': '華夏',
    '1307': '三芳',
    '1308': '亞聚',
    '1309': '台達化',
    '1310': '台苯',
    '1312': '國喬',
    '1313': '聯成',
    '1314': '中石化',
    '1315': '達新',
    '1321': '大洋',
    '1323': '永裕',
    '1324': '地球',
    '1325': '恆大',
    '1326': '台化',
    '1337': '再生-KY',
    '1340': '勝悅-KY',
    '1341': '富林-KY',
    '1342': '八貫',
    '4306': '炎洲',
    '1704': '榮化',
    '1402': '遠東新',
    '1409': '新纖',
    '1410': '南染',
    '1413': '宏洲',
    '1414': '東和',
    '1416': '廣豐',
    '1417': '嘉裕',
    '1418': '東華',
    '1419': '新紡',
    '1423': '利華',
    '1432': '大魯閣',
    '1434': '福懋',
    '1435': '中福',
    '1436': '華友聯',
    '1437': '勤益控',
    '1438': '三地開發',
    '1439': '中和',
    '1440': '南紡',
    '1441': '大東',
    '1442': '名軒',
    '1443': '立益',
    '1444': '力麗',
    '1445': '大宇',
    '1446': '宏和',
    '1447': '力鵬',
    '1449': '佳和',
    '1451': '年興',
    '1452': '宏益',
    '1453': '大將',
    '1454': '台富',
    '1455': '集盛',
    '1456': '怡華',
    '1457': '宜進',
    '1459': '聯發',
    '1460': '宏遠',
    '1463': '強盛',
    '1464': '得力',
    '1465': '偉全',
    '1466': '聚隆',
    '1467': '南緯',
    '1468': '昶和',
    '1470': '大統新創',
    '1471': '首利',
    '1472': '三洋紡',
    '1473': '台南',
    '1474': '弘裕',
    '1475': '業旺',
    '1476': '儒鴻',
    '1477': '聚陽',
    '2929': '淘帝-KY',
    '4414': '如興',
    '4426': '利勤',
    '4438': '廣越',
    '1710': '東聯',
    '1503': '士電',
    '1504': '東元',
    '1506': '正道',
    '1507': '永大',
    '1512': '瑞利',
    '1513': '中興電',
    '1514': '亞力',
    '1515': '力山',
    '1516': '川飛',
    '1517': '利奇',
    '1519': '華城',
    '1521': '大億',
    '1522': '堤維西',
    '1524': '耿鼎',
    '1525': '江申',
    '1526': '日馳',
    '1527': '鑽全',
    '1528': '恩德',
    '1529': '樂士',
    '1530': '亞崴',
    '1531': '高林股',
    '1532': '勤美',
    '1533': '車王電',
    '1535': '中宇',
    '1536': '和大',
    '1537': '廣隆',
    '1538': '正峰',
    '1539': '巨庭',
    '1540': '喬福',
    '1541': '錩泰',
    '1558': '伸興',
    '1560': '中砂',
    '1568': '倉佑',
    '1582': '信錦',
    '1583': '程泰',
    '1589': '永冠-KY',
    '1590': '亞德客-KY',
    '1592': '英瑞-KY',
    '1597': '直得',
    '2049': '上銀',
    '2228': '劍麟',
    '2231': '為升',
    '2233': '宇隆',
    '2236': '百達-KY',
    '2239': '英利-KY',
    '2241': '艾姆勒',
    '2243': '宏旭-KY',
    '2247': '汎德永業',
    '3162': '精確',
    '4503': '金雨',
    '4506': '崇友',
    '4510': '高鋒',
    '4513': '福裕',
    '4523': '永彰',
    '4526': '東台',
    '4527': '方土霖',
    '4528': '江興鍛',
    '4529': '淳紳',
    '4530': '宏易',
    '4532': '瑞智',
    '4533': '協易機',
    '4534': '慶騰',
    '4535': '至興',
    '4536': '拓凱',
    '4540': '全球傳動',
    '4541': '晟田',
    '4542': '科嶠',
    '4543': '萬在',
    '4545': '銘鈺',
    '4549': '桓達',
    '4550': '長佳',
    '4551': '智伸科',
    '4552': '力達-KY',
    '4554': '橙的',
    '4555': '氣立',
    '4556': '旭然',
    '4557': '永新-KY',
    '4560': '強信-KY',
    '4561': '健椿',
    '4562': '科定',
    '4563': '百德',
    '4564': '元翎',
    '4566': '時碩工業',
    '4569': '六方科-KY',
    '4571': '鈞興-KY',
    '4572': '駐龍',
    '4573': '高明',
    '4576': '大銀微系統',
    '4577': '商億-KY',
    '4578': '危老-KY',
    '4581': '光隆精密-KY',
    '4583': '台灣精銳',
    '4588': '玖鼎電力',
    '5288': '豐祥-KY',
    '6603': '富強鑫',
    '6609': '瀧澤科',
    '8027': '鈦昇',
    '8222': '寶一',
    '8234': '新漢',
    '8255': '朋程',
    '8374': '羅昇',
    '8996': '高力',
    '1605': '華新',
    '1609': '大亞',
    '1612': '宏泰',
    '1615': '大山',
    '1616': '億泰',
    '2430': '燦坤',
    '1603': '華電',
    '1608': '華榮',
    '1611': '中電',
    '1614': '三洋電',
    '1617': '榮星',
    '1618': '合機',
    '1626': '艾美特-KY',
    '1701': '中化',
    '1707': '葡萄王',
    '1708': '東鹼',
    '1709': '和益',
    '1711': '永光',
    '1712': '興農',
    '1713': '國化',
    '1714': '和桐',
    '1717': '長興',
    '1718': '中纖',
    '1720': '生達',
    '1721': '三晃',
    '1722': '台肥',
    '1723': '中碳',
    '1724': '台硝',
    '1725': '元禎',
    '1726': '永記',
    '1727': '中華化',
    '1730': '花仙子',
    '1731': '美吾華',
    '1732': '毛寶',
    '1733': '五鼎',
    '1734': '杏輝',
    '1735': '日勝化',
    '1736': '喬山',
    '1742': '台蠟',
    '1752': '南光',
    '1760': '寶齡富錦',
    '1762': '中化生',
    '1773': '勝一',
    '1776': '展宇',
    '1783': '和康生',
    '1786': '科妍',
    '1795': '美時',
    '1799': '易威',
    '3708': '上緯投控',
    '4702': '中美實',
    '4706': '大恭',
    '4707': '磐亞',
    '4711': '永純',
    '4712': '南璋',
    '4714': '永捷',
    '4716': '大立',
    '4720': '德淵',
    '4721': '美琪瑪',
    '4722': '國精化',
    '4725': '信昌化',
    '4726': '永昕',
    '4728': '雙美',
    '4729': '熒茂',
    '4733': '上緯',
    '4734': '欣雄',
    '4738': '尚化',
    '4739': '康普',
    '4741': '泓瀚',
    '4743': '合一',
    '4744': '皇將',
    '4745': '合富-KY',
    '4746': '台耀',
    '4747': '強生',
    '4754': '國碳科',
    '4755': '三福化',
    '4760': '勤凱',
    '4763': '材料-KY',
    '4764': '雙鍵',
    '4766': '南寶',
    '4767': '誠泰科技',
    '4768': '晶碩',
    '4770': '上品',
    '4771': '望隼',
    '5234': '達興材料',
    '6509': '聚和',
    '6664': '群翊',
    '6799': '來頡',
    '7756': '晟德',
    '8342': '益張',
    '1802': '台玻',
    '1805': '寶徠',
    '1806': '冠軍',
    '1808': '潤隆',
    '1809': '中釉',
    '1810': '和成',
    '1817': '凱撒衛',
    '1903': '士紙',
    '1904': '正隆',
    '1905': '華紙',
    '1906': '寶隆',
    '1907': '永豐餘',
    '1909': '榮成',
    '2002': '中鋼',
    '2006': '東和鋼鐵',
    '2007': '燁興',
    '2008': '高興昌',
    '2009': '第一銅',
    '2010': '春源',
    '2012': '春雨',
    '2013': '中鋼構',
    '2014': '中鴻',
    '2015': '豐興',
    '2017': '官田鋼',
    '2020': '美亞',
    '2022': '聚亨',
    '2023': '燁輝',
    '2024': '志聯',
    '2025': '千興',
    '2027': '大成鋼',
    '2028': '威致',
    '2029': '盛餘',
    '2030': '彰源',
    '2031': '新光鋼',
    '2032': '新鋼',
    '2033': '佳大',
    '2034': '允強',
    '2035': '唐榮',
    '2038': '海光',
    '2059': '川湖',
    '2063': '世鎧',
    '2064': '晉椿',
    '2065': '世豐',
    '2069': '運錩',
    '2070': '精湛',
    '2072': '世紀風電',
    '2073': '雄順',
    '2211': '長榮鋼',
    '5007': '三星',
    '5009': '榮剛',
    '5011': '久陽',
    '5013': '強新',
    '5014': '建錩',
    '5015': '華祺',
    '5016': '松和',
    '5536': '聖暉',
    '8349': '恒耀',
    '9958': '世紀鋼',
    '9962': '有益',
    '2101': '南港',
    '2102': '泰豐',
    '2103': '台橡',
    '2104': '國際中橡',
    '2105': '正新',
    '2106': '建大',
    '2107': '厚生',
    '2108': '南帝',
    '2109': '華豐',
    '2114': '鑫永銓',
    '2115': '六暉-KY',
    '6582': '申豐',
    '2201': '裕隆',
    '2204': '中華',
    '2206': '三陽工業',
    '2207': '和泰車',
    '2208': '台船',
    '2227': '裕日車',
    '2250': 'IKKA-KY',
    '2501': '國建',
    '2504': '國產',
    '2505': '國揚',
    '2506': '太設',
    '2509': '全坤建',
    '2511': '太子',
    '2514': '龍邦',
    '2515': '中工',
    '2516': '新建',
    '2520': '冠德',
    '2524': '京城',
    '2527': '宏璟',
    '2528': '皇普',
    '2530': '華建',
    '2534': '宏盛',
    '2535': '達欣工',
    '2536': '宏普',
    '2537': '聯上發',
    '2538': '基泰',
    '2539': '櫻花建',
    '2540': '愛山林',
    '2542': '興富發',
    '2543': '皇昌',
    '2545': '皇翔',
    '2546': '根基',
    '2547': '日勝生',
    '2548': '華固',
    '2597': '潤弘',
    '2841': '台開',
    '2923': '鼎固-KY',
    '5508': '永信建',
    '5511': '德昌',
    '5512': '力麒',
    '5514': '三豐',
    '5515': '建國',
    '5516': '雙喜',
    '5519': '隆大',
    '5520': '力泰',
    '5521': '工信',
    '5522': '遠雄',
    '5523': '豐謙',
    '5525': '順天',
    '5529': '志嘉',
    '5530': '龍巖',
    '5531': '鄉林',
    '5533': '皇鼎',
    '5534': '長華',
    '5543': '崇佑-KY',
    '5546': '永固-KY',
    '6171': '亞銳士',
    '9906': '欣巴巴',
    '9946': '三發地產',
    '2601': '益航',
    '2603': '長榮',
    '2605': '新興',
    '2606': '裕民',
    '2607': '榮運',
    '2608': '嘉里大榮',
    '2609': '陽明',
    '2610': '華航',
    '2611': '志信',
    '2612': '中航',
    '2613': '中櫃',
    '2614': '東森',
    '2615': '萬海',
    '2616': '山隆',
    '2617': '台航',
    '2618': '長榮航',
    '2630': '亞航',
    '2633': '台灣高鐵',
    '2634': '漢翔',
    '2636': '台驊投控',
    '2637': '慧洋-KY',
    '2640': '大車隊',
    '2641': '正德',
    '2642': '宅配通',
    '2643': '捷迅',
    '2645': '長榮航太',
    '2646': '星宇航空',
    '5601': '台聯櫃',
    '5603': '陸海',
    '5604': '中連貨',
    '5607': '遠雄港',
    '5608': '四維航',
    '5609': '中菲行',
    '8367': '建新國際',
    '2701': '萬企',
    '2702': '華園',
    '2704': '國賓',
    '2705': '六福',
    '2706': '第一店',
    '2707': '晶華',
    '2712': '遠雄來',
    '2718': '晶悅',
    '2719': '燦星旅',
    '2722': '夏都',
    '2723': '美食-KY',
    '2724': '富驛-KY',
    '2727': '王品',
    '2729': '瓦城',
    '2731': '雄獅',
    '2732': '六角',
    '2734': '易飛網',
    '2736': '高野',
    '2739': '寒舍',
    '2740': '天蔥',
    '2743': '山富',
    '2745': '五福',
    '2748': '雲品',
    '2752': '豆府',
    '2753': '八方雲集',
    '2754': '亞洲藏壽司',
    '2755': '揚秦',
    '2756': '聯發國際',
    '5701': '劍湖山',
    '5703': '亞都',
    '5704': '老爺知',
    '5706': '鳳凰',
    '8940': '新天地',
    '9943': '好樂迪',
    '2801': '彰銀',
    '2809': '京城銀',
    '2812': '台中銀',
    '2816': '旺旺保',
    '2820': '華票',
    '2823': '中壽',
    '2832': '台產',
    '2834': '臺企銀',
    '2836': '高雄銀',
    '2838': '聯邦銀',
    '2845': '遠東銀',
    '2849': '安泰銀',
    '2850': '新產',
    '2851': '中再保',
    '2852': '第一保',
    '2855': '統一證',
    '2867': '三商壽',
    '2880': '華南金',
    '2881': '富邦金',
    '2882': '國泰金',
    '2883': '開發金',
    '2884': '玉山金',
    '2885': '元大金',
    '2886': '兆豐金',
    '2887': '台新金',
    '2888': '新光金',
    '2889': '國票金',
    '2890': '永豐金',
    '2891': '中信金',
    '2892': '第一金',
    '2897': '王道銀行',
    '5864': '致和證',
    '5876': '上海商銀',
    '5878': '台名',
    '5880': '合庫金',
    '6005': '群益證',
    '6023': '元大期',
    '6024': '群益期',
    '6026': '福邦證',
    '2901': '欣欣',
    '2903': '遠百',
    '2904': '匯僑',
    '2905': '三商',
    '2906': '高林',
    '2908': '特力',
    '2910': '統領',
    '2911': '麗嬰房',
    '2912': '統一超',
    '2913': '農林',
    '2915': '潤泰全',
    '2916': '滿心',
    '2926': '誠品生活',
    '2936': '客思達-KY',
    '2937': '集雅社',
    '2939': '凱羿-KY',
    '5903': '全家',
    '5904': '寶雅',
    '5905': '南仁湖',
    '5906': '台南-KY',
    '5907': '大洋-KY',
    '6733': '博謙',
    '8403': '盛弘',
    '8428': '東捷',
    '8433': '弘帆',
    '8455': '大拓-KY',
    '9960': '邁達康',
    '1729': '必翔',
    '3118': '進階',
    '3164': '景岳',
    '3176': '基亞',
    '3705': '永信',
    '4102': '永日',
    '4104': '佳醫',
    '4105': '東洋',
    '4106': '雃博',
    '4107': '邦特',
    '4108': '懷特',
    '4109': '穆拉德',
    '4111': '濟生',
    '4113': '聯上',
    '4114': '健喬',
    '4116': '明基醫',
    '4119': '旭富',
    '4120': '友華',
    '4121': '優盛',
    '4123': '晟德',
    '4126': '太醫',
    '4127': '天良',
    '4128': '中天',
    '4129': '聯合',
    '4130': '健亞',
    '4133': '亞諾法',
    '4137': '麗豐-KY',
    '4138': '曜亞',
    '4139': '馬光-KY',
    '4141': '龍燈-KY',
    '4142': '國光生',
    '4144': '康聯-KY',
    '4147': '中裕',
    '4148': '全宇生技-KY',
    '4152': '台微體',
    '4153': '鈺緯',
    '4154': '康樂-KY',
    '4155': '訊映',
    '4157': '太景*-KY',
    '4160': '創源',
    '4161': '聿新科',
    '4162': '智擎',
    '4163': '鐿鈦',
    '4164': '承業醫',
    '4167': '松瑞藥',
    '4168': '醣聯',
    '4169': '泰宗',
    '4170': '鑫品',
    '4171': '瑞基',
    '4173': '久裕',
    '4174': '浩鼎',
    '4175': '杏一',
    '4180': '安克',
    '4183': '福永生技',
    '4190': '佐登-KY',
    '4192': '杏國',
    '4198': '環瑞醫',
    '6130': '基因',
    '6446': '藥華藥',
    '6461': '益得',
    '6469': '大樹',
    '6472': '保瑞',
    '6492': '生華科',
    '6496': '科懋',
    '6499': '益安',
    '6508': '惠光',
    '6517': '保勝光學',
    '6523': '達爾膚',
    '6535': '順藥',
    '6541': '泰福-KY',
    '6547': '高端疫苗',
    '6550': '北極星藥業-KY',
    '6569': '醫揚',
    '6574': '霈方',
    '6576': '逸達',
    '6586': '醣基',
    '6589': '台康生技',
    '6612': '奈米醫材',
    '6615': '慧智',
    '6641': '基士德-KY',
    '6653': '正瀚',
    '6657': '華安',
    '6679': '鈺太',
    '6703': '軒郁',
    '6712': '長聖',
    '6732': '昇佳電子',
    '6743': '安普新',
    '6747': '亨泰光',
    '6762': '達亞',
    '6781': 'AES-KY',
    '6788': '華景電',
    '6794': '向榮生技',
    '6846': '明遠精密',
    '6855': '數泓科',
    '6865': '偉康科技',
    '6866': '均華',
    '6869': '雲豹能源',
    '6903': '巨有科技',
    '3218': '大學光',
    '2348': '海悅',
    '2424': '全科',
    '2443': '新利虹',
    '2468': '華經',
    '2477': '美隆電',
    '2488': '昇達科',
    '2496': '卓越',
    '3029': '零壹',
    '3152': '璟德',
    '5283': '禾聯碩',
    '5301': '寶得利',
    '5314': '世紀',
    '5483': '中美晶',
    '5820': '日盛金',
    '6103': '合邦',
    '6139': '亞翔',
    '6184': '大豐電',
    '6191': '精成科',
    '6198': '瑞芳',
    '6199': '天品',
    '6264': '富堡',
    '6404': '通訊-KY',
    '6482': '弘塑',
    '6485': '點序',
    '6561': '是方',
    '6624': '萬年清',
    '6670': '復盛應用',
    '6691': '洋基工程',
    '6806': '森崴能源',
    '6807': '峰源-KY',
    '6829': '千附精密',
    '6873': '泓德能源',
    '6933': 'AMAX-KY',
    '6937': '天虹',
    '7634': '大樹',
    '8033': '雷虎',
    '8040': '九暘',
    '8299': '群聯',
    '8404': '百和興業-KY',
    '8410': '森田',
    '8415': '大國鋼',
    '8416': '實威',
    '8418': '必應',
    '8420': '明揚',
    '8421': '旭源',
    '8422': '可寧衛',
    '8423': '保綠-KY',
    '8424': '惠普',
    '8426': '紅木-KY',
    '8429': '金麗-KY',
    '8431': '匯鑽科',
    '8432': '東生華',
    '8435': '鉅邁',
    '8436': '大江',
    '8437': '大地-KY',
    '8440': '綠電',
    '8444': '綠河-KY',
    '8446': '華研',
    '8450': '霹靂',
    '8454': '富邦媒',
    '8462': '柏文',
    '8463': '潤泰材',
    '8464': '億豐',
    '8466': '美吉吉-KY',
    '8467': '波力-KY',
    '8472': '夠麻吉',
    '8473': '山林水',
    '8476': '台境',
    '8477': '創業家',
    '8478': '東哥遊艇',
    '8480': '泰昇-KY',
    '8481': '政伸',
    '8482': '商之器',
    '8488': '吉源-KY',
    '8489': '三貝德',
    '8497': '聯廣',
    '8499': '鼎炫-KY',
    '8905': '裕國',
    '8906': '花王',
    '8913': '全銓',
    '8916': '光隆',
    '8924': '大田',
    '8926': '台汽電',
    '8927': '北基',
    '8928': '鉅明',
    '8930': '青鋼',
    '8931': '大汽電',
    '8932': '宏大',
    '8933': '愛地雅',
    '8935': '邦泰',
    '8936': '國統',
    '8937': '合騏',
    '8938': '明安',
    '8942': '森鉅',
    '9902': '台火',
    '9904': '寶成',
    '9905': '大華',
    '9907': '統一實',
    '9908': '大台北',
    '9910': '豐泰',
    '9911': '櫻花',
    '9912': '偉聯',
    '9914': '美利達',
    '9917': '中保',
    '9918': '欣天然',
    '9919': '康那香',
    '9921': '巨大',
    '9924': '福興',
    '9925': '新保',
    '9926': '新海',
    '9927': '泰銘',
    '9928': '中視',
    '9929': '秋雨',
    '9930': '中聯資源',
    '9931': '欣高',
    '9933': '中鼎',
    '9934': '成霖',
    '9935': '慶豐富',
    '9937': '全國',
    '9938': '百和',
    '9939': '宏全',
    '9940': '信義',
    '9941': '裕融',
    '9942': '茂順',
    '9944': '新麗',
    '9945': '潤泰新',
    '9950': '萬國通',
    '9951': '皇田',
    '9955': '佳龍',
    '5306': '桂盟',
    '8341': '日友',
    '8401': '白紗科',
    '8411': '福貞-KY',
    '8908': '欣雄',
    '8917': '欣泰',
    '8923': '時報',
    '5203': '訊連',
    '6101': '弘捷',
    '6111': '大宇資',
    '6165': '捷泰',
    '6183': '關貿',
    '9802': '鈺齊-KY',
    '2301': '光寶科',
    '2302': '麗正',
    '2303': '聯電',
    '2305': '全友',
    '2308': '台達電',
    '2312': '金寶',
    '2313': '華通',
    '2314': '台揚',
    '2316': '楠梓電',
    '2317': '鴻海',
    '2321': '東訊',
    '2323': '中環',
    '2324': '仁寶',
    '2328': '廣宇',
    '2329': '華泰',
    '2330': '台積電',
    '2331': '精英',
    '2337': '旺宏',
    '2338': '光罩',
    '2340': '光磊',
    '2345': '智邦',
    '2347': '聯強',
    '2349': '錸德',
    '2351': '順德',
    '2352': '佳世達',
    '2353': '宏碁',
    '2354': '鴻準',
    '2355': '敬鵬',
    '2356': '英業達',
    '2357': '華碩',
    '2358': '廷鑫',
    '2359': '所羅門',
    '2360': '致茂',
    '2362': '藍天',
    '2363': '矽統',
    '2364': '倫飛',
    '2365': '昆盈',
    '2367': '燿華',
    '2368': '金像電',
    '2369': '菱生',
    '2371': '大同',
    '2373': '震旦行',
    '2374': '佳能',
    '2375': '智寶',
    '2376': '技嘉',
    '2377': '微星',
    '2379': '瑞昱',
    '2380': '虹光',
    '2382': '廣達',
    '2383': '台光電',
    '2385': '群光',
    '2387': '精元',
    '2388': '威盛',
    '2390': '云辰',
    '2392': '正崴',
    '2393': '億光',
    '2395': '研華',
    '2397': '友通',
    '2399': '映泰',
    '2401': '凌陽',
    '2402': '毅嘉',
    '2404': '漢唐',
    '2405': '浩鑫',
    '2406': '國碩',
    '2409': '友達',
    '2412': '中華電',
    '2413': '環科',
    '2414': '精技',
    '2415': '錩新',
    '2417': '圓剛',
    '2419': '仲琦',
    '2420': '新巨',
    '2421': '建準',
    '2423': '固緯',
    '2425': '承啟',
    '2426': '鼎元',
    '2427': '三商電',
    '2428': '興勤',
    '2429': '銘異',
    '2431': '聯昌',
    '2433': '互盛電',
    '2434': '統懋',
    '2436': '偉詮電',
    '2438': '翔耀',
    '2439': '美律',
    '2440': '太空梭',
    '2441': '超豐',
    '2442': '新美齊',
    '2444': '兆勁',
    '2449': '京元電子',
    '2450': '神腦',
    '2451': '創見',
    '2453': '凌群',
    '2454': '聯發科',
    '2455': '全新',
    '2456': '奇力新',
    '2457': '飛宏',
    '2458': '義隆',
    '2459': '敦吉',
    '2460': '建通',
    '2461': '光群雷',
    '2462': '良得電',
    '2464': '盟立',
    '2465': '麗臺',
    '2466': '冠西電',
    '2467': '志聖',
    '2471': '資通',
    '2472': '立隆電',
    '2474': '可成',
    '2476': '鉅祥',
    '2478': '大毅',
    '2480': '敦陽科',
    '2481': '強茂',
    '2482': '連宇',
    '2483': '百容',
    '2484': '希華',
    '2485': '兆赫',
    '2486': '一詮',
    '2489': '瑞軒',
    '2491': '吉祥全',
    '2492': '華新科',
    '2493': '揚博',
    '2495': '普安',
    '2497': '怡利電',
    '2498': '宏達電',
    '3002': '歐格',
    '3003': '健和興',
    '3004': '豐達科',
    '3005': '神基',
    '3006': '晶豪科',
    '3008': '大立光',
    '3010': '華立',
    '3011': '今皓',
    '3013': '晟銘電',
    '3014': '聯陽',
    '3015': '全漢',
    '3016': '嘉晶',
    '3017': '奇鋐',
    '3018': '同開',
    '3019': '亞光',
    '3021': '鴻名',
    '3022': '威強電',
    '3023': '信邦',
    '3024': '憶聲',
    '3025': '星通',
    '3026': '禾伸堂',
    '3027': '盛達',
    '3028': '增你強',
    '3030': '德律',
    '3031': '佰鴻',
    '3032': '偉訓',
    '3033': '威健',
    '3034': '聯詠',
    '3035': '智原',
    '3036': '文曄',
    '3037': '欣興',
    '3038': '森田',
    '3040': '遠見',
    '3041': '揚智',
    '3042': '晶技',
    '3043': '科風',
    '3044': '健鼎',
    '3045': '台灣大',
    '3046': '建碁',
    '3047': '訊舟',
    '3048': '益登',
    '3049': '和頻',
    '3050': '鈺德',
    '3051': '力特',
    '3052': '夆典',
    '3054': '立萬利',
    '3055': '蔚華科',
    '3056': '總太',
    '3057': '喬鼎',
    '3058': '立德',
    '3059': '華晶科',
    '3060': '銘異',
    '3062': '建漢',
    '3090': '日電貿',
    '3092': '鴻碩',
    '3094': '聯傑',
    '3128': '昇銳',
    '3130': '一零四',
    '3149': '正達',
    '3167': '大量',
    '3189': '景碩',
    '3209': '全科',
    '3211': '順達',
    '3213': '茂訊',
    '3217': '優群',
    '3224': '三顧',
    '3227': '原相',
    '3228': '金麗科',
    '3230': '錦明',
    '3231': '緯創',
    '3234': '光環',
    '3236': '千如',
    '3252': '海灣',
    '3257': '虹冠電',
    '3264': '欣銓',
    '3265': '台星科',
    '3266': '昇陽',
    '3272': '東碩',
    '3284': '太普高',
    '3285': '微端',
    '3287': '廣寰科',
    '3289': '宜特',
    '3290': '東浦',
    '3293': '鈊象',
    '3294': '英濟',
    '3296': '勝德',
    '3297': '杭特',
    '3303': '岱稜',
    '3305': '昇貿',
    '3306': '鼎天',
    '3308': '聯德',
    '3310': '佳穎',
    '3311': '閎暉',
    '3312': '弘憶股',
    '3313': '斐成',
    '3315': '宣德',
    '3317': '尼克森',
    '3321': '同泰',
    '3322': '建舜電',
    '3323': '加高',
    '3324': '雙鴻',
    '3325': '旭品',
    '3332': '幸康',
    '3338': '泰碩',
    '3339': '泰谷',
    '3346': '麗清',
    '3354': '律勝',
    '3356': '奇偶',
    '3360': '尚立',
    '3362': '先進光',
    '3363': '上詮',
    '3372': '典範',
    '3373': '熱映',
    '3374': '精材',
    '3376': '新日興',
    '3379': '彬台',
    '3380': '明泰',
    '3383': '金龍',
    '3388': '崇越電',
    '3390': '旭軟',
    '3402': '漢科',
    '3406': '玉晶光',
    '3413': '京鼎',
    '3416': '融程電',
    '3419': '譁裕',
    '3432': '台端',
    '3437': '榮創',
    '3438': '類比科',
    '3441': '聯一光',
    '3443': '創意',
    '3444': '吉茂',
    '3450': '聯鈞',
    '3454': '晶睿',
    '3455': '由田',
    '3465': '祥業',
    '3466': '致振',
    '3479': '安勤',
    '3481': '群創',
    '3483': '力致',
    '3484': '崧騰',
    '3490': '單井',
    '3491': '昇達科',
    '3494': '誠研',
    '3498': '陽程',
    '3499': '環天科',
    '3501': '維熹',
    '3504': '揚明光',
    '3508': '位速',
    '3511': '矽瑪',
    '3512': '能緹',
    '3515': '華擎',
    '3516': '亞帝歐',
    '3518': '柏騰',
    '3520': '振維',
    '3521': '鴻翊',
    '3522': '宏森',
    '3523': '迎輝',
    '3526': '凡甲',
    '3527': '聚積',
    '3528': '安馳',
    '3529': '力旺',
    '3530': '晶相光',
    '3531': '愛普',
    '3532': '台勝科',
    '3533': '嘉澤',
    '3535': '晶彩科',
    '3536': '誠創',
    '3537': '堡達',
    '3540': '曜越',
    '3541': '西柏',
    '3543': '州巧',
    '3545': '敦泰',
    '3546': '宇峻',
    '3548': '兆利',
    '3550': '聯穎',
    '3551': '世禾',
    '3552': '同致',
    '3555': '重鳥鵬',
    '3556': '禾瑞亞',
    '3558': '神準',
    '3559': '全智科',
    '3563': '牧德',
    '3564': '其陽',
    '3567': '逸昌',
    '3570': '大塚',
    '3576': '聯合再生',
    '3577': '泓格',
    '3580': '友威科',
    '3581': '博磊',
    '3583': '辛耘',
    '3587': '閎康',
    '3588': '通嘉',
    '3591': '艾笛森',
    '3592': '瑞瀚',
    '3593': '力銘',
    '3594': '磐儀',
    '3596': '智易',
    '3605': '宏致',
    '3607': '谷崧',
    '3609': '三一東林',
    '3611': '鼎翰',
    '3615': '安可',
    '3617': '碩天',
    '3622': '洋華',
    '3623': '富晶通',
    '3624': '光頡',
    '3625': '西勝',
    '3628': '盈正',
    '3630': '新鉅科',
    '3631': '晟鈦',
    '3632': '研勤',
    '3642': '達邁',
    '3645': '達爾膚',
    '3646': '艾恩特',
    '3652': '精聯',
    '3653': '健策',
    '3661': '世芯-KY',
    '3663': '鑫科',
    '3664': '安控',
    '3665': '貿聯-KY',
    '3666': '光耀',
    '3669': '圓展',
    '3673': 'TPK-KY',
    '3675': '德微',
    '3679': '新至陞',
    '3680': '家登',
    '3682': '亞太電',
    '3684': '榮旗',
    '3685': '元創精密',
    '3686': '達能',
    '3687': '歐買尬',
    '3689': '湧德',
    '3691': '碩禾',
    '3693': '營邦',
    '3694': '海華',
    '3698': '隆中',
    '3701': '大眾控',
    '3702': '大聯大',
    '3703': '欣陸',
    '3704': '合勤控',
    '3706': '神達',
    '3707': '漢磊',
    '3709': '昱捷',
    '3710': '連展投控',
    '3711': '日月光投控',
    '3712': '永崴投控',
    '3713': '新晶投控',
    '3714': '富采',
    '3715': '定穎投控',
    '4904': '遠傳',
    '4905': '台聯電',
    '4906': '正文',
    '4908': '前鼎',
    '4909': '新復興',
    '4911': '德英',
    '4912': '聯德控股-KY',
    '4915': '致伸',
    '4916': '事欣科',
    '4919': '新唐',
    '4923': '力士',
    '4924': '欣厚-KY',
    '4927': '泰鼎-KY',
    '4930': '燦星網',
    '4933': '友輝',
    '4934': '太極',
    '4935': '茂林-KY',
    '4938': '和碩',
    '4939': '亞電',
    '4942': '嘉彰',
    '4943': '康控-KY',
    '4944': '兆遠',
    '4945': '陞達科技',
    '4946': '辣椒',
    '4952': '凌通',
    '4953': '緯軟',
    '4956': '光鋐',
    '4958': '臻鼎-KY',
    '4960': '誠美材',
    '4961': '天鈺',
    '4966': '譜瑞-KY',
    '4968': '立積',
    '4971': 'IET-KY',
    '4972': '湯石照明',
    '4973': '廣穎',
    '4974': '亞泰',
    '4976': '佳凌',
    '4977': '眾達-KY',
    '4979': '華星光',
    '4987': '科誠',
    '4991': '環宇-KY',
    '4994': '傳奇',
    '4995': '晶達',
    '4999': '鑫禾',
    '5201': '凱衛',
    '5202': '力新',
    '5209': '新鼎',
    '5210': '寶碩',
    '5211': '蒙恬',
    '5212': '凌網',
    '5213': '亞昕',
    '5215': '科嘉-KY',
    '5220': '萬達光電',
    '5222': '全訊',
    '5223': '安力-KY',
    '5225': '東科-KY',
    '5227': '立凱-KY',
    '5230': '雷笛克光學',
    '5236': '凌陽創新',
    '5243': '乙盛-KY',
    '5244': '弘凱',
    '5245': '智晶',
    '5248': '稼宇',
    '5251': '天鉞電',
    '5258': '虹堡',
    '5263': '智崴',
    '5269': '祥碩',
    '5272': '笙科',
    '5274': '信驊',
    '5276': '達輝-KY',
    '5278': '尚凡',
    '5281': '大峽谷-KY',
    '5284': 'jpp-KY',
    '5285': '界霖',
    '5287': '數字',
    '5291': '邑錡',
    '5299': '杰力',
    '5309': '系統電',
    '5310': '中兵',
    '5312': '寶島科',
    '5315': '光聯',
    '5321': '美而快',
    '5324': '士開',
    '5328': '華容',
    '5340': '建榮',
    '5344': '立衛',
    '5345': '天揚',
    '5348': '系通',
    '5351': '鈺創',
    '5353': '台林',
    '5355': '佳總',
    '5356': '協益',
    '5371': '中光電',
    '5381': '合正',
    '5383': '金利',
    '5386': '青雲',
    '5388': '中磊',
    '5392': '應華',
    '5398': '慕康生醫',
    '5403': '中菲',
    '5410': '國眾',
    '5425': '台半',
    '5426': '振發',
    '5432': '達威',
    '5434': '崇越',
    '5438': '東友',
    '5439': '高技',
    '5443': '均豪',
    '5450': '寶聯通',
    '5452': '佶優',
    '5455': '訊利電',
    '5457': '宣德',
    '5460': '同協',
    '5464': '霖宏',
    '5465': '富驊',
    '5468': '凱鈺',
    '5469': '瀚宇博',
    '5471': '松翰',
    '5474': '聰泰',
    '5475': '德宏',
    '5478': '智冠',
    '5481': '華韡',
    '5484': '慧友',
    '5487': '通泰',
    '5488': '松普',
    '5489': '彩富',
    '5490': '同亨',
    '5493': '三聯',
    '5498': '凱崴',
    '6104': '創惟',
    '6105': '瑞傳',
    '6108': '競國',
    '6109': '亞元',
    '6112': '聚碩',
    '6113': '亞矽',
    '6114': '久威',
    '6115': '鎰勝',
    '6116': '彩晶',
    '6117': '迎廣',
    '6118': '建達',
    '6120': '達運',
    '6121': '新普',
    '6122': '擎邦',
    '6123': '上奇',
    '6124': '業強',
    '6125': '廣運',
    '6126': '信音',
    '6127': '九豪',
    '6128': '上福',
    '6129': '普誠',
    '6131': '悠克',
    '6133': '金橋',
    '6134': '萬旭',
    '6136': '富爾特',
    '6138': '茂達',
    '6140': '訊達',
    '6141': '柏承',
    '6142': '友勁',
    '6143': '振曜',
    '6144': '得利影',
    '6146': '耕興',
    '6147': '頎邦',
    '6148': '驊宏資',
    '6150': '撼訊',
    '6151': '晉倫',
    '6152': '百一',
    '6153': '嘉聯益',
    '6154': '順發',
    '6155': '鈞寶',
    '6156': '松上',
    '6158': '禾昌',
    '6160': '欣技',
    '6161': '捷波',
    '6163': '華電網',
    '6164': '華興',
    '6166': '凌華',
    '6167': '久正',
    '6168': '宏齊',
    '6169': '互億',
    '6170': '統振',
    '6173': '信昌電',
    '6174': '安碁',
    '6175': '立敦',
    '6176': '瑞儀',
    '6177': '達麗',
    '6179': '亞通',
    '6180': '橘子',
    '6182': '合晶',
    '6185': '幃翔',
    '6186': '新潤',
    '6187': '萬潤',
    '6188': '廣明',
    '6189': '豐藝',
    '6190': '萬泰科',
    '6192': '巨路',
    '6194': '育富',
    '6195': '詩肯',
    '6196': '帆宣',
    '6197': '佳必琪',
    '6201': '亞弘電',
    '6202': '盛群',
    '6203': '海韻電',
    '6204': '艾華',
    '6205': '詮欣',
    '6206': '飛捷',
    '6207': '雷科',
    '6208': '日揚',
    '6209': '今國光',
    '6210': '慶生',
    '6213': '聯茂',
    '6214': '精誠',
    '6215': '和椿',
    '6216': '居易',
    '6217': '中探針',
    '6218': '豪勉',
    '6219': '富旺',
    '6220': '岳豐',
    '6221': '晉泰',
    '6223': '旺矽',
    '6224': '聚鼎',
    '6225': '天瀚',
    '6226': '光鼎',
    '6227': '茂綸',
    '6228': '全譜',
    '6229': '研通',
    '6230': '超眾',
    '6231': '系微',
    '6233': '旺玖',
    '6234': '高賢',
    '6235': '華孚',
    '6236': '康呈',
    '6237': '驊訊',
    '6239': '力成',
    '6240': '松崗',
    '6242': '立康',
    '6243': '迅杰',
    '6244': '茂迪',
    '6245': '立端',
    '6246': '臺龍',
    '6247': '淇譽電',
    '6248': '沛波',
    '6251': '定穎',
    '6257': '矽格',
    '6259': '百徽',
    '6261': '久元',
    '6263': '普萊德',
    '6265': '方土暢',
    '6266': '泰詠',
    '6269': '台郡',
    '6270': '倍微',
    '6271': '同欣電',
    '6274': '台燿',
    '6275': '元山',
    '6276': '安鈦克',
    '6277': '宏正',
    '6278': '台表科',
    '6279': '胡連',
    '6281': '全國電',
    '6282': '康舒',
    '6283': '淳安',
    '6284': '佳邦',
    '6285': '啟碁',
    '6287': '元隆',
    '6288': '聯嘉',
    '6289': '華上',
    '6290': '良維',
    '6291': '沛亨',
    '6292': '迅德',
    '6294': '智基',
    '6298': '崴強',
    '6405': '悅城',
    '6409': '旭隼',
    '6411': '晶焱',
    '6412': '群電',
    '6414': '樺漢',
    '6415': '矽力-KY',
    '6416': '瑞祺電通',
    '6417': '韋僑',
    '6418': '詠昇',
    '6422': '君耀-KY',
    '6426': '統新',
    '6431': '光麗-KY',
    '6432': '今展科',
    '6435': '大中',
    '6438': '迅得',
    '6441': '廣錠',
    '6442': '光聖',
    '6449': '鈺邦',
    '6451': '訊芯-KY',
    '6456': 'GIS-KY',
    '6457': '紘康',
    '6462': '神盾',
    '6465': '威潤',
    '6470': '宇智',
    '6477': '安集',
    '6486': '互動',
    '6488': '環球晶',
    '6491': '晶碩',
    '6494': '九齊',
    '6504': '南六',
    '6506': '雙邦',
    '6510': '精測',
    '6512': '啟發電',
    '6514': '芮特-KY',
    '6515': '穎崴',
    '6516': '勤崴國際',
    '6525': '捷敏-KY',
    '6527': '明達醫',
    '6531': '愛普',
    '6532': '瑞耘',
    '6533': '晶心科',
    '6538': '倉和',
    '6542': '隆中',
    '6548': '長華科',
    '6552': '易華電',
    '6558': '興能高',
    '6560': '欣普羅',
    '6568': '宏觀',
    '6570': '維田',
    '6573': '虹揚-KY',
    '6577': '勁豐',
    '6578': '達邦蛋白',
    '6579': '研揚',
    '6588': '東典光電',
    '6590': '普鴻',
    '6591': '動力-KY',
    '6593': '台灣銘板',
    '6594': '展碁國際',
    '6605': '帝寶',
    '6606': '建新國際',
    '6613': '朋億',
    '6616': '特昇-KY',
    '6625': '必應',
    '6629': '泰金-KY',
    '6640': '均華',
    '6642': '富致',
    '6643': 'M31',
    '6651': '全宇昕',
    '6666': '羅麗芬-KY',
    '6667': '信紘科',
    '6668': '中揚光',
    '6669': '緯穎',
    '6671': '三能-KY',
    '6672': '騰輝電子-KY',
    '6674': '鋐康',
    '6683': '雍智科技',
    '6690': '安碁資訊',
    '6693': '廣閎科',
    '6695': '芯測',
    '6697': '東捷資訊',
    '6698': '旭暉應材',
    '6706': '惠特',
    '6715': '嘉基',
    '6716': '應廣',
    '6719': '力智',
    '6727': '亞泰金屬',
    '6728': '上洋',
    '6730': '亞泰金屬',
    '6741': '91APP*-KY',
    '6751': '智聯服務',
    '6752': '叡揚',
    '6753': '龍德造船',
    '6754': '匯僑設計',
    '6756': '威鋒電子',
    '6761': '穩得',
    '6763': '綠界科技',
    '6768': '志強-KY',
    '6770': '力積電',
    '6776': '展碁國際',
    '6782': '視陽',
    '6789': '采鈺',
    '6791': '虎門科技',
    '6792': '詠業',
    '6796': '晉弘',
    '6803': '崑鼎',
    '6805': '富世達',
    '6811': '宏碁資訊',
    '6821': '聯寶',
    '6830': '汎銓',
    '6834': '天擎',
    '6841': '長佳智能',
    '6854': '錼創科技-KY',
    '6859': '伯特光',
    '6861': '睿生光電',
    '6863': '永道-KY',
    '6874': '倍力',
    '6901': '怡和國際',
    '6902': '富裔',
    '6908': '宏碁遊戲',
    '6913': '走著瞧-創',
    '6914': '浩漢',
    '6928': '益芯科技',
    '6934': '青新-創',
    '6949': '沛爾生醫-創',
    '6969': '成信實業-創',
    '8011': '台通',
    '8016': '矽創',
    '8021': '尖點',
    '8024': '佑華',
    '8028': '昇陽半導體',
    '8032': '光菱',
    '8034': '榮群',
    '8038': '長園科',
    '8039': '台虹',
    '8042': '金山電',
    '8043': '蜜望實',
    '8044': '網家',
    '8046': '南電',
    '8047': '星雲',
    '8048': '德勝',
    '8049': '晶采',
    '8050': '廣積',
    '8054': '安國',
    '8059': '凱碩',
    '8064': '東捷',
    '8066': '來思達',
    '8067': '志旭',
    '8068': '全達',
    '8069': '元太',
    '8070': '長華',
    '8071': '能率網通',
    '8072': '陞泰',
    '8074': '鉅橡',
    '8076': '伍豐',
    '8077': '洛碁',
    '8080': '奧斯特',
    '8081': '致新',
    '8083': '瑞穎',
    '8084': '巨虹',
    '8085': '福華',
    '8086': '宏捷科',
    '8087': '華鎂鑫',
    '8089': '康全電訊',
    '8091': '翔名',
    '8092': '建暐',
    '8093': '保銳',
    '8096': '擎亞',
    '8097': '常珵',
    '8099': '大世科',
    '8101': '華冠',
    '8103': '瀚荃',
    '8104': '錸寶',
    '8105': '凌巨',
    '8107': '大億金茂',
    '8109': '博大',
    '8110': '華東',
    '8111': '立碁',
    '8112': '至上',
    '8114': '振維',
    '8121': '宏齊',
    '8131': '福懋油',
    '8147': '正淩',
    '8150': '南茂',
    '8155': '博智',
    '8163': '達方',
    '8171': '天宇',
    '8176': '智捷',
    '8182': '加高',
    '8183': '精星',
    '8201': '無敵',
    '8210': '勤誠',
    '8213': '志超',
    '8215': '明基材',
    '8227': '巨有科技',
    '8240': '華宏',
    '8249': '菱光',
    '8261': '富鼎',
    '8279': '生泰',
    '8287': '英格爾',
    '8289': '泰藝',
    '8291': '尚茂',
    '8358': '金居',
    '8383': '千附',
    '8390': '金益鼎',
}

@st.cache_data(ttl=3600)
def parse_sector_data():
    tickers = []
    sector_map = {}
    for sec, stocks in RAW_SECTOR_DATA.items():
        for s in stocks:
            tickers.append(s)
            sector_map[s] = sec
    return list(set(tickers)), sector_map

# ==========================================
# 2. 數據下載與計算 (台股專用)
# ==========================================

@st.cache_data(ttl=3600)
def get_market_data(tickers):
    if not tickers:
        return pd.DataFrame(), {}
    
    # 智能下載策略：先試 .TW，若無資料再試 .TWO
    valid_tickers_map = {}
    to_download_tw = [f"{t}.TW" for t in tickers]
    
    progress_bar = st.progress(0, text="Downloading Taiwan Stock Data...")
    
    # 1. 嘗試下載上市 (.TW)
    try:
        data_tw = yf.download(to_download_tw, period="1y", group_by='ticker', threads=True, auto_adjust=True)
    except Exception as e:
        st.error(f"Download Error: {e}")
        return pd.DataFrame(), {}
        
    final_data = pd.DataFrame()
    failed_codes = []

    if not data_tw.empty:
        for code in tickers:
            tw_ticker = f"{code}.TW"
            # 檢查是否有資料
            if tw_ticker in data_tw.columns:
                stock_df = data_tw[tw_ticker]
                # 簡單檢查：最近5天內至少有1天有收盤價
                if not stock_df['Close'].tail(5).dropna().empty:
                    valid_tickers_map[code] = tw_ticker
                else:
                    failed_codes.append(code)
            else:
                failed_codes.append(code)
    else:
        failed_codes = tickers

    progress_bar.progress(50, text="Checking OTC stocks...")

    # 2. 針對失敗的嘗試下載上櫃 (.TWO)
    if failed_codes:
        to_download_two = [f"{t}.TWO" for t in failed_codes]
        try:
            data_two = yf.download(to_download_two, period="1y", group_by='ticker', threads=True, auto_adjust=True)
            
            for code in failed_codes:
                two_ticker = f"{code}.TWO"
                if two_ticker in data_two.columns:
                     stock_df = data_two[two_ticker]
                     if not stock_df['Close'].tail(5).dropna().empty:
                         valid_tickers_map[code] = two_ticker
        except Exception:
            pass

    progress_bar.progress(90, text="Merging data...")

    # 3. 合併數據
    combined_dict = {}
    all_valid_yf_tickers = list(valid_tickers_map.values())
    
    if not data_tw.empty:
        for t in data_tw.columns.levels[0]:
            if t in all_valid_yf_tickers:
                combined_dict[t] = data_tw[t]
                
    if failed_codes and not data_two.empty:
        for t in data_two.columns.levels[0]:
            if t in all_valid_yf_tickers:
                combined_dict[t] = data_two[t]

    if combined_dict:
        final_data = pd.concat(combined_dict, axis=1, keys=combined_dict.keys())
    
    progress_bar.empty()
    return final_data, valid_tickers_map

def get_latest_snapshot_with_strategy(data, tickers, sector_map, ticker_map):
    results = []
    
    for code in tickers:
        try:
            yf_ticker = ticker_map.get(code)
            if not yf_ticker or yf_ticker not in data.columns:
                continue
                
            df = data[yf_ticker].copy()
            df = df.dropna(subset=['Close', 'Volume'])
            if df.empty or len(df) < 20: continue 
            
            curr = df.iloc[-1]
            prev = df.iloc[-2]
            
            close = float(curr['Close'])
            prev_close = float(prev['Close'])
            change_pct = ((close - prev_close) / prev_close) * 100
            volume = float(curr['Volume'])
            prev_volume = float(prev['Volume'])
            
            ma20 = df['Close'].rolling(20).mean().iloc[-1]
            ma50 = df['Close'].rolling(50).mean().iloc[-1] if len(df) >= 50 else ma20
            ma150 = df['Close'].rolling(150).mean().iloc[-1] if len(df) >= 150 else ma50
            ma200 = df['Close'].rolling(200).mean().iloc[-1] if len(df) >= 200 else ma50
            
            high_52w = df['High'].tail(252).max()
            low_52w = df['Low'].tail(252).min()
            
            avg_vol_20 = df['Volume'].iloc[-21:-1].mean()
            if pd.isna(avg_vol_20) or avg_vol_20 == 0: avg_vol_20 = 1
            r_vol = volume / avg_vol_20
            
            # --- 策略判斷 ---
            trend_score = 0
            if close > ma50 > ma150 > ma200: trend_score += 1
            if close > low_52w * 1.3: trend_score += 1
            if close > high_52w * 0.75: trend_score += 1
            is_super_trend = (trend_score == 3)
            
            is_pocket_pivot = False
            if change_pct > 0:
                last_10 = df.iloc[-11:-1]
                down_days = last_10[last_10['Close'] < last_10['Open']]
                if not down_days.empty:
                    if volume > down_days['Volume'].max(): is_pocket_pivot = True
                elif volume > last_10['Volume'].max(): is_pocket_pivot = True

            is_vol_explosion = (r_vol > 2.5) and (volume > 500000)
            is_price_up_vol_down = (change_pct > 0) and (volume < prev_volume)
            is_price_down_vol_up = (change_pct < 0) and (volume > prev_volume)
            is_price_down_vol_down = (change_pct < 0) and (volume < prev_volume)
            
            volatility = ((curr['High'] - curr['Low']) / prev['Close']) * 100

            # 取得股票名稱
            name = STOCK_NAMES.get(code, code)

            results.append({
                'Ticker': code,
                'Name': name,  # 新增 Name 欄位
                'Sector': sector_map.get(code, ''),
                'Close': close, 
                'Change %': change_pct, 
                'Volume': volume,
                'RVol': r_vol, 
                '52W High': high_52w, 
                '52W Low': low_52w,
                'Super Trend': is_super_trend, 
                'Pocket Pivot': is_pocket_pivot,
                'Vol Explosion': is_vol_explosion,
                'Price Up Vol Down': is_price_up_vol_down,
                'Price Down Vol Up': is_price_down_vol_up,
                'Price Down Vol Down': is_price_down_vol_down,
                'Volatility': volatility
            })
        except Exception:
            continue
            
    return pd.DataFrame(results)

# ==========================================
# 3. 視覺化
# ==========================================

def main():
    st.title("📊 Taiwan Stock Pro Dashboard (台股專業儀表板)")
    st.write(f"Last Update: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M')}")
    st.info("系統包含 1000+ 檔台股，初次載入需時約 1-2 分鐘，請耐心等候。")
    
    if st.button("🔄 Refresh Data"):
        st.cache_data.clear()
        st.rerun()

    with st.spinner('Downloading & Calculating...'):
        tickers, sector_map = parse_sector_data()
        full_data, ticker_map = get_market_data(tickers)
        
        if full_data.empty:
            st.error("Data download failed. Please try again.")
            return

        df_snapshot = get_latest_snapshot_with_strategy(full_data, tickers, sector_map, ticker_map)

    if df_snapshot.empty:
        st.warning("No valid data found.")
        return

    # 修復後的 fmt 函數：增加欄位存在檢查，避免 KeyError
    def fmt(df, val_col=None, fmt_str='{:.2f}'):
        d = df.copy()
        if 'Close' in d.columns: d['Close'] = d['Close'].map('{:,.2f}'.format)
        if 'Change %' in d.columns: d['Change %'] = d['Change %'].map('{:+.2f}%'.format)
        if '52W High' in d.columns: d['52W High'] = d['52W High'].map('{:,.2f}'.format)
        if '52W Low' in d.columns: d['52W Low'] = d['52W Low'].map('{:,.2f}'.format)
        if 'Volume' in d.columns: d['Volume'] = (d['Volume']/1000).map('{:,.0f}張'.format)
             
        if val_col and val_col in d.columns and fmt_str:
            d[val_col] = d[val_col].map(fmt_str.format)
        return d

    def add_table(df, cols):
        # 確保只顯示存在的欄位
        valid_cols = [c for c in cols if c in df.columns]
        return go.Figure(data=[go.Table(
            header=dict(values=valid_cols, fill_color='navy', font=dict(color='white'), align='left'),
            cells=dict(values=[df[k] for k in valid_cols], fill_color='lavender', align='left')
        )]).update_layout(height=300, margin=dict(l=0,r=0,t=0,b=0))

    # 定義表格欄位 (新增 Name)
    cols_basic = ['Ticker', 'Name', 'Sector', 'Close', 'Change %', 'Volume', 'RVol', 'Val']
    cols_adv = ['Ticker', 'Name', 'Sector', 'Close', 'Change %', 'Volume', '52W High', '52W Low']

    # --- Part 1: 強勢股篩選 ---
    st.header("一、 強勢股篩選 (Top Performers)")
    
    col1, col2 = st.columns(2)
    with col1:
        st.subheader("🔥 超級趨勢股 (Super Trend)")
        df_super = df_snapshot[df_snapshot['Super Trend'] == True].sort_values('RVol', ascending=False).head(10)
        st.plotly_chart(add_table(fmt(df_super, 'RVol', '{:.2f}x'), cols_adv), use_container_width=True)
        
        st.subheader("🚀 漲幅最強 Top 10")
        gainer_df = df_snapshot.sort_values('Change %', ascending=False).head(10)
        gainer_df['Val'] = gainer_df['RVol']
        st.plotly_chart(add_table(fmt(gainer_df, 'Val', '{:.2f}x'), cols_basic), use_container_width=True)

    with col2:
        st.subheader("💎 口袋支點爆量 (Pocket Pivot)")
        df_pocket = df_snapshot[df_snapshot['Pocket Pivot'] == True].sort_values('Change %', ascending=False).head(10)
        st.plotly_chart(add_table(fmt(df_pocket, 'RVol', '{:.2f}x'), cols_adv), use_container_width=True)

        st.subheader("💧 跌幅最重 Top 10")
        loser_df = df_snapshot.sort_values('Change %', ascending=True).head(10)
        loser_df['Val'] = loser_df['RVol']
        st.plotly_chart(add_table(fmt(loser_df, 'Val', '{:.2f}x'), cols_basic), use_container_width=True)

    # --- Part 2: 量價篩選策略 ---
    st.header("二、 量價篩選策略 (Volume & Price Analysis)")
    
    col3, col4 = st.columns(2)
    
    with col3:
        st.subheader("🌋 成交量暴增 (>2.5倍均量)")
        df_expl = df_snapshot[df_snapshot['Vol Explosion'] == True].sort_values('RVol', ascending=False).head(20)
        if not df_expl.empty:
            df_expl['Val'] = df_expl['RVol']
            st.plotly_chart(add_table(fmt(df_expl, 'Val', '{:.2f}x'), cols_basic), use_container_width=True)
        else:
            st.info("今日無符合條件個股")

        st.subheader("📉 價跌量增 (恐慌拋售?)")
        df_pdvu = df_snapshot[df_snapshot['Price Down Vol Up'] == True].sort_values('Change %', ascending=True).head(20)
        if not df_pdvu.empty:
             df_pdvu['Val'] = df_pdvu['RVol']
             st.plotly_chart(add_table(fmt(df_pdvu, 'Val', '{:.2f}x'), cols_basic), use_container_width=True)
        else:
            st.info("今日無符合條件個股")

    with col4:
        st.subheader("📈 價漲量縮 (惜售/背離?)")
        df_puvd = df_snapshot[df_snapshot['Price Up Vol Down'] == True].sort_values('Change %', ascending=False).head(20)
        if not df_puvd.empty:
             df_puvd['Val'] = df_puvd['RVol']
             st.plotly_chart(add_table(fmt(df_puvd, 'Val', '{:.2f}x'), cols_basic), use_container_width=True)
        else:
            st.info("今日無符合條件個股")

        st.subheader("❄️ 價跌量縮 (量縮回檔?)")
        df_pdvd = df_snapshot[df_snapshot['Price Down Vol Down'] == True].sort_values('Change %', ascending=True).head(20)
        if not df_pdvd.empty:
             df_pdvd['Val'] = df_pdvd['RVol']
             st.plotly_chart(add_table(fmt(df_pdvd, 'Val', '{:.2f}x'), cols_basic), use_container_width=True)
        else:
            st.info("今日無符合條件個股")

if __name__ == "__main__":
    main()
