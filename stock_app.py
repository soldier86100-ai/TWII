import streamlit as st
import yfinance as yf
import pandas as pd
import plotly.graph_objects as go
import datetime
import time

st.set_page_config(layout="wide", page_title="Taiwan Stock Pro Dashboard")

# ==========================================
# 1. æ ¸å¿ƒæ•¸æ“šå®šç¾© (å°è‚¡ç”¢æ¥­åˆ†é¡æ¸…å–®)
# ==========================================

# æ ¹æ“šæ‚¨æä¾›çš„æª”æ¡ˆç”Ÿæˆçš„å®Œæ•´å°è‚¡æ¸…å–®
RAW_SECTOR_DATA = {
    'DRAMè£½é€ ': ['2342', '2344', '2408', '3260', '4967', '5289', '5347', '8088', '8271', '8277'],
    'æ°´æ³¥': ['1101', '1102', '1103', '1104', '1108', '1109', '1110'],
    'é£Ÿå“æ¥­': ['1210', '1215', '1216', '1218', '1219', '1225', '1227', '1229', '1231', '1232', '1233', '1234', '1236', '1702', '1737'],
    'è‚‰å“åŠ å·¥': ['1213', '1256'],
    'å¡‘è† æ¥­': ['1301', '1303', '1304', '1305', '1307', '1308', '1309', '1310', '1312', '1313', '1314', '1315', '1321', '1323', '1324', '1325', '1326', '1337', '1340', '1341', '1342', '4306'],
    'èšä¹™çƒ¯PE': ['1301', '1304', '1308', '1323'],
    'èšæ°¯ä¹™çƒ¯PVC': ['1301', '1304', '1305', '1312', '1323'],
    'èšä¸™çƒ¯PP': ['1303', '1304', '1314', '1326', '1704'],
    'èšè‹¯ä¹™çƒ¯PS': ['1303', '1310', '1312', '1314'],
    'ABSæ¨¹è„‚': ['1303', '1309', '1310', '1312'],
    'å¯å¡‘åŠ‘DOP': ['1312', '1313'],
    'è‹¯ä¹™çƒ¯SM': ['1310', '1314'],
    'CPLã€AN': ['1314'],
    'åˆæˆçš®': ['1301', '1303', '1315'],
    'ç´¡çº–æ¥­': ['1402', '1409', '1410', '1413', '1414', '1416', '1417', '1418', '1419', '1423', '1432', '1434', '1435', '1436', '1437', '1438', '1439', '1440', '1441', '1442', '1443', '1444', '1445', '1446', '1447', '1449', '1451', '1452', '1453', '1454', '1455', '1456', '1457', '1459', '1460', '1463', '1464', '1465', '1466', '1467', '1468', '1470', '1471', '1472', '1473', '1474', '1475', '1476', '1477', '2929', '4414', '4426', '4438'],
    'åŒ–çº–åŸæ–™': ['1409', '1417', '1444', '1455', '1710'],
    'èšé…¯ç²’ã€æ£‰ã€çµ²': ['1402', '1409', '1416', '1417', '1423', '1434', '1440', '1442', '1444', '1446', '1447', '1452', '1453', '1454', '1455', '1457', '1459', '1460', '1463', '1464', '1466', '1471', '1472', '2929'],
    'åŠ å·¥çµ²': ['1409', '1417', '1444', '1447', '1452', '1453', '1454', '1455', '1456', '1459', '1464', '1466', '1471'],
    'ç¾Šæ¯›': ['1413', '1435', '1437'],
    'äºå…‹åŠ›æ£‰': ['1451'],
    'é›»æ©Ÿæ©Ÿæ¢°': ['1503', '1504', '1506', '1507', '1512', '1513', '1514', '1515', '1516', '1517', '1519', '1521', '1522', '1524', '1525', '1526', '1527', '1528', '1529', '1530', '1531', '1532', '1533', '1535', '1536', '1537', '1538', '1539', '1540', '1541', '1558', '1560', '1568', '1582', '1583', '1589', '1590', '1592', '1597', '2049', '2228', '2231', '2233', '2236', '2239', '2241', '2243', '2247', '3162', '4503', '4506', '4510', '4513', '4523', '4526', '4527', '4528', '4529', '4530', '4532', '4533', '4534', '4535', '4536', '4540', '4541', '4542', '4543', '4545', '4549', '4550', '4551', '4552', '4554', '4555', '4556', '4557', '4560', '4561', '4562', '4563', '4564', '4566', '4569', '4571', '4572', '4573', '4576', '4577', '4578', '4581', '4583', '4588', '5288', '6603', '6609', '8027', '8222', '8234', '8255', '8374', '8996'],
    'å®¶é›»': ['1503', '1504', '1506', '1507', '1605', '1609', '1612', '1615', '1616', '2430'],
    'é›»æ©Ÿ': ['1503', '1504', '1513', '1514', '1519'],
    'é›¶ä»¶': ['1506', '1512', '1516', '1517', '1521', '1522', '1524', '1525', '1527', '1528', '1533', '1536', '1538', '1539', '1540', '1541', '2239'],
    'æ©Ÿæ¢°': ['1515', '1526', '1529', '1530', '1531', '1532', '1535', '1537', '1582', '1583', '1590', '1597', '4526', '4532', '4533', '4540'],
    'é›»å™¨é›»çºœ': ['1603', '1605', '1608', '1609', '1611', '1612', '1614', '1615', '1616', '1617', '1618', '1626'],
    'åŒ–å·¥æ¥­': ['1701', '1702', '1704', '1707', '1708', '1709', '1710', '1711', '1712', '1713', '1714', '1717', '1718', '1720', '1721', '1722', '1723', '1724', '1725', '1726', '1727', '1730', '1731', '1732', '1733', '1734', '1735', '1736', '1737', '1742', '1752', '1760', '1762', '1773', '1776', '1783', '1786', '1795', '1799', '3708', '4702', '4706', '4707', '4711', '4712', '4714', '4716', '4720', '4721', '4722', '4725', '4726', '4728', '4729', '4733', '4734', '4738', '4739', '4741', '4743', '4744', '4745', '4746', '4747', '4754', '4755', '4760', '4763', '4764', '4766', '4767', '4768', '4770', '4771', '5234', '6509', '6664', '6799', '7756', '8342'],
    'ç»ç’ƒé™¶ç“·': ['1802', '1805', '1806', '1808', '1809', '1810', '1817'],
    'é€ ç´™æ¥­': ['1903', '1904', '1905', '1906', '1907', '1909'],
    'é‹¼éµæ¥­': ['2002', '2006', '2007', '2008', '2009', '2010', '2012', '2013', '2014', '2015', '2017', '2020', '2022', '2023', '2024', '2025', '2027', '2028', '2029', '2030', '2031', '2032', '2033', '2034', '2035', '2038', '2059', '2063', '2064', '2065', '2069', '2070', '2072', '2073', '2211', '5007', '5009', '5011', '5013', '5014', '5015', '5016', '5536', '8349', '9958', '9962'],
    'æ©¡è† æ¥­': ['2101', '2102', '2103', '2104', '2105', '2106', '2107', '2108', '2109', '2114', '2115', '6582'],
    'æ±½è»Šæ¥­': ['2201', '2204', '2206', '2207', '2208', '2227', '2250'],
    'ç‡Ÿå»ºæ¥­': ['1438', '1442', '1453', '1805', '1808', '2501', '2504', '2505', '2506', '2509', '2511', '2514', '2515', '2516', '2520', '2524', '2527', '2528', '2530', '2534', '2535', '2536', '2537', '2538', '2539', '2540', '2542', '2543', '2545', '2546', '2547', '2548', '2597', '2841', '2923', '5508', '5511', '5512', '5514', '5515', '5516', '5519', '5520', '5521', '5522', '5523', '5525', '5529', '5530', '5531', '5533', '5534', '5543', '5546', '6171', '9906', '9946'],
    'é‹è¼¸æ¥­': ['2208', '2601', '2603', '2605', '2606', '2607', '2608', '2609', '2610', '2611', '2612', '2613', '2614', '2615', '2616', '2617', '2618', '2630', '2633', '2634', '2636', '2637', '2640', '2641', '2642', '2643', '2645', '2646', '5601', '5603', '5604', '5607', '5608', '5609', '8367'],
    'è§€å…‰æ¥­': ['2701', '2702', '2704', '2705', '2706', '2707', '2712', '2718', '2719', '2722', '2723', '2724', '2727', '2729', '2731', '2732', '2734', '2736', '2739', '2740', '2743', '2745', '2748', '2752', '2753', '2754', '2755', '2756', '5701', '5703', '5704', '5706', '8940', '9943'],
    'é‡‘èä¿éšª': ['2801', '2809', '2812', '2816', '2820', '2823', '2832', '2834', '2836', '2838', '2845', '2849', '2850', '2851', '2852', '2855', '2867', '2880', '2881', '2882', '2883', '2884', '2885', '2886', '2887', '2888', '2889', '2890', '2891', '2892', '2897', '5864', '5876', '5878', '5880', '6005', '6023', '6024', '6026'],
    'ç™¾è²¨è²¿æ˜“': ['2901', '2903', '2904', '2905', '2906', '2908', '2910', '2911', '2912', '2913', '2915', '2916', '2926', '2936', '2937', '2939', '5903', '5904', '5905', '5906', '5907', '6733', '8403', '8428', '8433', '8455', '9960'],
    'æ¸…æ½”ç”¨å“': ['1702', '1737'],
    'ç”ŸåŒ–è£½è—¥': ['1701', '1707', '1720', '1729', '1731', '1733', '1734', '1736', '1760', '1762', '1795', '3118', '3164', '3176', '3705', '4102', '4104', '4105', '4106', '4108', '4109', '4111', '4114', '4116', '4119', '4120', '4121', '4123', '4126', '4127', '4128', '4129', '4130', '4133', '4137', '4138', '4141', '4142', '4144', '4147', '4148', '4152', '4153', '4154', '4155', '4157', '4160', '4161', '4162', '4163', '4164', '4167', '4168', '4169', '4170', '4171', '4173', '4174', '4175', '4180', '4183', '4190', '4192', '4198', '4726', '4728', '4738', '4743', '4746', '6446', '6461', '6469', '6472', '6492', '6496', '6499', '6517', '6523', '6535', '6541', '6547', '6550', '6569', '6574', '6576', '6586', '6589', '6612', '6615', '6641', '6657', '6679', '6703', '6712', '6732', '6743', '6747', '6762', '6781', '6788', '6794', '6846', '6855', '6865', '6866', '6869', '6903'],
    'æ¨¹è„‚': ['1301', '1303', '1305', '1309', '1312', '1314', '1326', '1704', '1714'],
    'é†«ç™‚å“èˆ‡é€šè·¯': ['1701', '1707', '1713', '1720', '1731', '1733', '1734', '1736', '1783', '1799', '3218', '4104', '4106', '4107', '4113', '4138', '4139', '4154', '4161', '4163', '4167', '4171', '4173', '4175', '4180', '4728', '4734', '4745', '6130', '6509', '6653'],
    'è¾²è—¥è‚¥æ–™': ['1708', '1722', '1723', '1727', '1730', '6508'],
    'è† ã€è† å¸¶': ['1324', '1727', '2101', '2105', '2108'],
    'ç´™æ¼¿': ['1905', '1906'],
    'å·¥æ¥­ç”¨ç´™': ['1903', '1904', '1906', '1907', '1909'],
    'æ–‡åŒ–ç”¨ç´™': ['1904', '1905', '1906', '1907'],
    'å®¶åº­ç”¨ç´™': ['1904', '1906'],
    'ç›¤å…ƒç·šæ': ['2006', '2010', '2012', '2022', '2028', '2033', '2064', '2211', '5009', '9958'],
    'é‹¼ç­‹': ['2006', '2015', '2017', '2020', '2028', '2035', '2038', '5007', '5009', '5536'],
    'é‹¼æ¿': ['2002', '2008', '2010', '2023', '2025', '2029', '2031'],
    'ç†±è»‹é‹¼æ²': ['2002', '2008', '2010', '2014', '2023', '2029'],
    'é‹¼çµæ§‹': ['2007', '2009', '2013', '2024', '2025', '2063', '5536', '9962'],
    'é‹¼ç®¡': ['2014', '2020', '2027', '2029', '2030', '2031', '2034', '5015', '5016'],
    'å†·è»‹é‹¼æ²': ['2002', '2008', '2009', '2010', '2023', '2029', '9958'],
    'éé‹…é‹¼æ²': ['2002', '2008', '2009', '2010', '2023', '2029', '9958'],
    'ä¸é½é‹¼': ['2008', '2010', '2025', '2027', '2030', '2031', '2032', '2033', '2034', '2069', '5009', '5013', '5014', '5016', '8349', '9958', '9962'],
    'éçƒ¤é‹…é‹¼å“': ['2008', '2009', '2010', '2023', '2029', '9958'],
    'ééµé‡‘å±¬': ['1605', '2009', '9927'],
    'è¼ªèƒ': ['2102', '2103', '2104', '2105', '2106', '2107', '2108', '2109'],
    'å…¶ä»–æ©¡è† ': ['2101', '2114', '2115'],
    'æ±½è»Š': ['2201', '2204', '2207', '2227'],
    'æ©Ÿè»Š': ['2206', '2208'],
    'ç‡Ÿé€ ': ['2501', '2505', '2511', '2515', '2524', '2535', '2546', '2548', '5511', '5519', '5521', '5530', '5531', '5534', '5543', '9906'],
    'ç‡Ÿå»º': ['1438', '1442', '1453', '1805', '1808', '2501', '2504', '2505', '2506', '2509', '2514', '2516', '2520', '2524', '2527', '2528', '2530', '2534', '2536', '2537', '2538', '2539', '2540', '2542', '2543', '2545', '2547', '2597', '2841', '2923', '5508', '5512', '5515', '5516', '5522', '5523', '5525', '5529', '5533', '5546', '9946'],
    'ç©ºé‹': ['2610', '2618', '2634', '2645', '2646', '5609'],
    'æ•£è£èˆªé‹': ['2601', '2605', '2606', '2612', '2614', '2617', '2637', '2641', '2642', '5601', '5608'],
    'è²¨æ«ƒèˆªé‹': ['2603', '2609', '2615'],
    'é™¸é‹': ['2607', '2608', '2616', '2633', '2636', '2640', '2643', '5603', '5604', '8367'],
    'å€‰å„²è²¨æ«ƒå ´': ['2607', '2611', '2613', '5607'],
    'é‡‘æ§': ['2880', '2881', '2882', '2883', '2884', '2885', '2886', '2887', '2888', '2889', '2890', '2891', '2892', '5880'],
    'éŠ€è¡Œ': ['2801', '2809', '2812', '2834', '2836', '2838', '2845', '2849', '2850', '2851', '2852', '2897', '5876'],
    'è­‰é‡‘ç¥¨åˆ¸': ['2816', '2820', '2855', '2889', '6023', '6024'],
    'ä¿éšª': ['2823', '2832', '2852', '2867', '5864', '5878', '6026'],
    'ç™¾è²¨é›¶å”®': ['2901', '2903', '2905', '2908', '2910', '2911', '2912', '2913', '2915', '2926', '2936', '2939', '5903', '5904', '5905', '5906', '5907', '6733', '8403', '8428', '8433', '8455', '9960'],
    'è²¿æ˜“': ['2904', '2906', '2916', '2937'],
    'å…¶ä»–': ['1439', '1526', '2012', '2107', '2250', '2348', '2424', '2443', '2468', '2477', '2488', '2496', '2514', '2630', '2841', '2923', '3029', '3152', '4123', '4129', '4137', '4148', '5283', '5301', '5314', '5483', '5514', '5520', '5820', '5876', '5878', '6103', '6139', '6171', '6184', '6191', '6198', '6199', '6264', '6404', '6482', '6485', '6561', '6624', '6670', '6691', '6806', '6807', '6829', '6873', '6933', '6937', '7634', '8033', '8040', '8299', '8404', '8410', '8415', '8416', '8418', '8420', '8421', '8422', '8423', '8424', '8426', '8429', '8431', '8432', '8435', '8436', '8437', '8440', '8444', '8446', '8450', '8454', '8462', '8463', '8464', '8466', '8467', '8472', '8473', '8476', '8477', '8478', '8480', '8481', '8482', '8488', '8489', '8497', '8499', '8905', '8906', '8913', '8916', '8924', '8926', '8927', '8928', '8930', '8931', '8932', '8933', '8935', '8936', '8937', '8938', '8942', '9902', '9904', '9905', '9907', '9908', '9910', '9911', '9912', '9914', '9917', '9918', '9919', '9921', '9924', '9925', '9926', '9927', '9928', '9929', '9930', '9931', '9933', '9934', '9935', '9937', '9938', '9939', '9940', '9941', '9942', '9944', '9945', '9950', '9951', '9955', '9962'],
    'è‡ªè¡Œè»Š': ['5306', '8928', '8930', '8932', '8933', '9914', '9921'],
    'å…¬ç”¨äº‹æ¥­': ['1514', '2613', '8341', '8401', '8411', '8422', '8437', '8478', '8905', '8908', '8917', '8923', '8926', '8927', '8931', '9902', '9908', '9917', '9918', '9931', '9933', '9937'],
    'æ–‡åŒ–å‚³æ’­äº‹æ¥­': ['5203', '6101', '6111', '6165', '6183', '8446', '8450', '8923', '9905', '9930'],
    'é‹æ¥­': ['8404', '9802', '9904', '9910', '9938'],
    'ä¿å…¨': ['9917', '9925'],
    'æ¶ˆè²»æ€§é›»å­': ['2301', '2302', '2303', '2305', '2308', '2312', '2313', '2314', '2316', '2317', '2321', '2323', '2324', '2328', '2329', '2330', '2331', '2337', '2338', '2340', '2342', '2344', '2345', '2347', '2348', '2349', '2351', '2352', '2353', '2354', '2355', '2356', '2357', '2358', '2359', '2360', '2362', '2363', '2364', '2365', '2367', '2368', '2369', '2371', '2373', '2374', '2375', '2376', '2377', '2379', '2380', '2382', '2383', '2385', '2387', '2388', '2390', '2392', '2393', '2395', '2397', '2399', '2401', '2402', '2404', '2405', '2406', '2408', '2409', '2412', '2413', '2414', '2415', '2417', '2419', '2420', '2421', '2423', '2424', '2425', '2426', '2427', '2428', '2429', '2430', '2431', '2433', '2434', '2436', '2438', '2439', '2440', '2441', '2442', '2443', '2444', '2449', '2450', '2451', '2453', '2454', '2455', '2456', '2457', '2458', '2459', '2460', '2461', '2462', '2464', '2465', '2466', '2467', '2468', '2471', '2472', '2474', '2476', '2477', '2478', '2480', '2481', '2482', '2483', '2484', '2485', '2486', '2488', '2489', '2491', '2492', '2493', '2495', '2496', '2497', '2498', '3002', '3003', '3004', '3005', '3006', '3008', '3010', '3011', '3013', '3014', '3015', '3016', '3017', '3018', '3019', '3021', '3022', '3023', '3024', '3025', '3026', '3027', '3028', '3029', '3030', '3031', '3032', '3033', '3034', '3035', '3036', '3037', '3038', '3040', '3041', '3042', '3043', '3044', '3045', '3046', '3047', '3048', '3049', '3050', '3051', '3052', '3054', '3055', '3056', '3057', '3058', '3059', '3060', '3062', '3090', '3092', '3094', '3128', '3130', '3149', '3167', '3189', '3209', '3211', '3213', '3217', '3224', '3227', '3228', '3230', '3231', '3234', '3236', '3252', '3257', '3260', '3264', '3265', '3266', '3272', '3284', '3285', '3287', '3289', '3290', '3293', '3294', '3296', '3297', '3303', '3305', '3306', '3308', '3310', '3311', '3312', '3313', '3315', '3317', '3321', '3322', '3323', '3324', '3325', '3332', '3338', '3339', '3346', '3354', '3356', '3360', '3362', '3363', '3372', '3373', '3374', '3376', '3379', '3380', '3383', '3388', '3390', '3402', '3406', '3413', '3416', '3419', '3432', '3437', '3438', '3441', '3443', '3444', '3450', '3454', '3455', '3465', '3466', '3479', '3481', '3483', '3484', '3490', '3491', '3494', '3498', '3499', '3501', '3504', '3508', '3511', '3512', '3515', '3516', '3518', '3520', '3521', '3522', '3523', '3526', '3527', '3528', '3529', '3530', '3531', '3532', '3533', '3535', '3536', '3537', '3540', '3541', '3543', '3545', '3546', '3548', '3550', '3551', '3552', '3555', '3556', '3558', '3559', '3563', '3564', '3567', '3570', '3576', '3577', '3580', '3581', '3583', '3587', '3588', '3591', '3592', '3593', '3594', '3596', '3605', '3607', '3609', '3611', '3615', '3617', '3622', '3623', '3624', '3625', '3628', '3630', '3631', '3632', '3642', '3645', '3646', '3652', '3653', '3661', '3663', '3664', '3665', '3666', '3669', '3673', '3675', '3679', '3680', '3682', '3684', '3685', '3686', '3687', '3689', '3691', '3693', '3694', '3698', '3701', '3702', '3703', '3704', '3706', '3707', '3709', '3710', '3711', '3712', '3713', '3714', '3715', '4542', '4904', '4905', '4906', '4908', '4909', '4911', '4912', '4915', '4916', '4919', '4923', '4924', '4927', '4930', '4933', '4934', '4935', '4938', '4939', '4942', '4943', '4944', '4945', '4946', '4952', '4953', '4956', '4958', '4960', '4961', '4966', '4967', '4968', '4971', '4972', '4973', '4974', '4976', '4977', '4979', '4987', '4991', '4994', '4995', '4999', '5201', '5202', '5209', '5210', '5211', '5212', '5213', '5215', '5220', '5222', '5223', '5225', '5227', '5230', '5234', '5236', '5243', '5244', '5245', '5248', '5251', '5258', '5263', '5269', '5272', '5274', '5276', '5278', '5281', '5284', '5285', '5287', '5288', '5289', '5291', '5299', '5309', '5310', '5312', '5315', '5321', '5324', '5328', '5340', '5344', '5345', '5347', '5348', '5351', '5353', '5355', '5356', '5371', '5381', '5383', '5386', '5388', '5392', '5398', '5403', '5410', '5425', '5426', '5432', '5434', '5438', '5439', '5443', '5450', '5452', '5455', '5457', '5460', '5464', '5465', '5468', '5469', '5471', '5474', '5475', '5478', '5481', '5484', '5487', '5488', '5489', '5490', '5493', '5498', '5536', '6104', '6105', '6108', '6109', '6112', '6113', '6114', '6115', '6116', '6117', '6118', '6120', '6121', '6122', '6123', '6124', '6125', '6126', '6127', '6128', '6129', '6131', '6133', '6134', '6136', '6138', '6140', '6141', '6142', '6143', '6144', '6146', '6147', '6148', '6150', '6151', '6152', '6153', '6154', '6155', '6156', '6158', '6160', '6161', '6163', '6164', '6166', '6167', '6168', '6169', '6170', '6173', '6174', '6175', '6176', '6177', '6179', '6180', '6182', '6185', '6186', '6187', '6188', '6189', '6190', '6192', '6194', '6195', '6196', '6197', '6201', '6202', '6203', '6204', '6205', '6206', '6207', '6208', '6209', '6210', '6213', '6214', '6215', '6216', '6217', '6218', '6219', '6220', '6221', '6223', '6224', '6225', '6226', '6227', '6228', '6229', '6230', '6231', '6233', '6234', '6235', '6236', '6237', '6239', '6240', '6242', '6243', '6244', '6245', '6246', '6247', '6248', '6251', '6257', '6259', '6261', '6263', '6265', '6266', '6269', '6270', '6271', '6274', '6275', '6276', '6277', '6278', '6279', '6281', '6282', '6283', '6284', '6285', '6287', '6288', '6289', '6290', '6291', '6292', '6294', '6298', '6405', '6409', '6411', '6412', '6414', '6415', '6416', '6417', '6418', '6422', '6426', '6431', '6432', '6435', '6438', '6441', '6442', '6449', '6451', '6456', '6457', '6462', '6465', '6470', '6477', '6486', '6488', '6491', '6494', '6504', '6506', '6510', '6512', '6514', '6515', '6516', '6525', '6527', '6531', '6532', '6533', '6538', '6542', '6548', '6552', '6558', '6560', '6568', '6570', '6573', '6577', '6578', '6579', '6588', '6590', '6591', '6593', '6594', '6605', '6606', '6613', '6616', '6625', '6629', '6640', '6642', '6643', '6651', '6666', '6667', '6668', '6669', '6671', '6672', '6674', '6683', '6690', '6693', '6695', '6697', '6698', '6706', '6715', '6716', '6719', '6727', '6728', '6730', '6741', '6751', '6752', '6753', '6754', '6756', '6761', '6763', '6768', '6770', '6776', '6782', '6789', '6791', '6792', '6796', '6803', '6805', '6811', '6821', '6830', '6834', '6841', '6854', '6859', '6861', '6863', '6874', '6901', '6902', '6908', '6913', '6914', '6928', '6934', '6949', '6969', '8011', '8016', '8021', '8024', '8028', '8032', '8034', '8038', '8039', '8042', '8043', '8044', '8046', '8047', '8048', '8049', '8050', '8054', '8059', '8064', '8066', '8067', '8068', '8069', '8070', '8071', '8072', '8074', '8076', '8077', '8080', '8081', '8083', '8084', '8085', '8086', '8087', '8088', '8089', '8091', '8092', '8093', '8096', '8097', '8099', '8101', '8103', '8104', '8105', '8107', '8109', '8110', '8111', '8112', '8114', '8121', '8131', '8147', '8150', '8155', '8163', '8171', '8176', '8182', '8183', '8201', '8210', '8213', '8215', '8227', '8234', '8240', '8249', '8255', '8261', '8271', '8277', '8279', '8287', '8289', '8291', '8358', '8383', '8390', '9911', '9912'],
    'æ•¸ä½ç›¸æ©Ÿ': ['2360', '2406', '3019', '3050', '3059', '3362', '3413', '3441', '3504', '4915', '4976', '5348', '5371', '5478', '6120', '6206', '6209', '8050'],
    'é‡æ¸¬å„€å™¨': ['2360', '3289', '3628', '6131', '6163', '6182', '6223', '6245'],
    'è¼¸å…¥è¨­å‚™': ['2324', '2365', '2380', '2385', '2387', '2425', '2440', '3230', '3297', '3390', '3570', '4935', '5215', '5478', '6121', '6233', '6244', '6276', '8050'],
    'æšè²å™¨': ['2402', '2439', '3003', '3024', '4916', '5215', '5490', '6208', '6679'],
    'å…¶ä»–å…ƒä»¶': ['1582', '2059', '2328', '2355', '2404', '2413', '2415', '2417', '2419', '2420', '2428', '2429', '2431', '2433', '2434', '2436', '2456', '2457', '2462', '2467', '2472', '2476', '2483', '2484', '2488', '2497', '3003', '3015', '3026', '3032', '3037', '3046', '3048', '3051', '3058', '3090', '3092', '3209', '3217', '3224', '3227', '3285', '3289', '3294', '3303', '3308', '3313', '3321', '3322', '3339', '3432', '3467', '3484', '3511', '3597', '3646', '4923', '4989', '4999', '5222', '6124', '6174', '6175', '6207', '6208', '6290', '6417', '6432', '6693', '6761', '6770', '6792', '8033', '8040', '8048', '8111', '8114'],
    'é›»æ„Ÿ': ['2428', '2436', '2456', '2472', '2484', '3227', '3313', '6127', '6155'],
    'å…‰å­¸å…ƒä»¶': ['2374', '2409', '2461', '2467', '3008', '3019', '3031', '3038', '3049', '3050', '3051', '3059', '3362', '3406', '3441', '3504', '3508', '3630', '4915', '4976', '5348', '5371', '5443', '6120', '6209', '6224', '8050', '8105'],
    'è®Šå£“å™¨': ['2328', '2413', '2420', '2431', '3046', '3209', '3321', '6155', '8040'],
    'é›»æ± ': ['1536', '1537', '1611', '1723', '2308', '2355', '2434', '3043', '3211', '3227', '3323', '3416', '3615', '3625', '4721', '4739', '4934', '5227', '6121', '6509', '8038', '8215'],
    'å·¥æ¥­é›»è…¦': ['2308', '2351', '2395', '2414', '3014', '3022', '3416', '3479', '3577', '4916', '5258', '6105', '6128', '6140', '6153', '6160', '6166', '6196', '6208', '6245', '6414', '6579', '8050', '8110', '8114', '8234']
}

@st.cache_data(ttl=3600)
def parse_sector_data():
    tickers = []
    sector_map = {}
    for sec, stocks in RAW_SECTOR_DATA.items():
        for s in stocks:
            tickers.append(s)
            sector_map[s] = sec  # Map stock code to sector
    return list(set(tickers)), sector_map

# ==========================================
# 2. æ•¸æ“šä¸‹è¼‰èˆ‡è¨ˆç®— (å°è‚¡å°ˆç”¨)
# ==========================================

@st.cache_data(ttl=3600)
def get_market_data(tickers):
    if not tickers:
        return pd.DataFrame(), {}
    
    # æ™ºèƒ½ä¸‹è¼‰ç­–ç•¥ï¼šå…ˆè©¦ .TWï¼Œè‹¥ç„¡è³‡æ–™å†è©¦ .TWO
    # ç”±æ–¼æ‰¹é‡ä¸‹è¼‰æ™‚æ··åˆç„¡æ•ˆ ticker æœƒå¾ˆäº‚ï¼Œé€™è£¡æ¡ç”¨åˆ†æ‰¹è™•ç†
    
    valid_tickers_map = {}
    
    # 1. é è¨­å…¨éƒ¨ç‚ºä¸Šå¸‚ (.TW)
    to_download_tw = [f"{t}.TW" for t in tickers]
    
    # åˆ†æ‰¹ä¸‹è¼‰ä»¥é¿å…è«‹æ±‚éå¤§
    data_list = []
    chunk_size = 100
    progress_bar = st.progress(0, text="Downloading Taiwan Stock Data...")
    
    # ç¬¬ä¸€æ¬¡å˜—è©¦ï¼šä¸‹è¼‰ .TW
    # ç‚ºæ±‚æ•ˆç‡ï¼Œæˆ‘å€‘ç›´æ¥ä¸‹è¼‰å…¨éƒ¨ä¸¦æª¢æŸ¥å“ªäº›å…¨ç‚º NaN
    try:
        data_tw = yf.download(to_download_tw, period="1y", group_by='ticker', threads=True, auto_adjust=True)
    except Exception as e:
        st.error(f"Download Error: {e}")
        return pd.DataFrame(), {}
        
    final_data = pd.DataFrame()
    failed_codes = []

    # æª¢æŸ¥æ•¸æ“šæœ‰æ•ˆæ€§
    if not data_tw.empty:
        # yfinance çš„å¤šå±¤ç´¢å¼•çµæ§‹ï¼š(Ticker, PriceType) or (PriceType, Ticker)
        # ä½¿ç”¨ group_by='ticker' å¾Œï¼Œç¬¬ä¸€å±¤ columns æ˜¯ Ticker
        
        for code in tickers:
            tw_ticker = f"{code}.TW"
            # æª¢æŸ¥è©² ticker æ˜¯å¦æœ‰ Close æ•¸æ“šä¸”éå…¨ç©º
            if tw_ticker in data_tw.columns:
                stock_df = data_tw[tw_ticker]
                if not stock_df['Close'].dropna().empty:
                    valid_tickers_map[code] = tw_ticker
                else:
                    failed_codes.append(code)
            else:
                failed_codes.append(code)
    else:
        failed_codes = tickers

    progress_bar.progress(50, text="Checking OTC stocks...")

    # 2. é‡å°å¤±æ•—çš„å˜—è©¦ä¸‹è¼‰ä¸Šæ«ƒ (.TWO)
    if failed_codes:
        to_download_two = [f"{t}.TWO" for t in failed_codes]
        try:
            data_two = yf.download(to_download_two, period="1y", group_by='ticker', threads=True, auto_adjust=True)
            
            for code in failed_codes:
                two_ticker = f"{code}.TWO"
                if two_ticker in data_two.columns:
                     stock_df = data_two[two_ticker]
                     if not stock_df['Close'].dropna().empty:
                         valid_tickers_map[code] = two_ticker
        except Exception:
            pass

    progress_bar.progress(90, text="Merging data...")

    # 3. åˆä½µæ‰€æœ‰æœ‰æ•ˆæ•¸æ“š
    # ç‚ºäº†æ–¹ä¾¿å¾ŒçºŒè™•ç†ï¼Œæˆ‘å€‘å»ºç«‹ä¸€å€‹åŒ…å«æ‰€æœ‰æœ‰æ•ˆè‚¡ç¥¨çš„å¤§å‹ DataFrame
    # é€™è£¡æˆ‘å€‘åªå– valid_tickers_map ä¸­çš„ ticker
    
    all_valid_yf_tickers = list(valid_tickers_map.values())
    
    # é‡æ–°æ•´ç†æ•¸æ“šçµæ§‹ï¼Œå› ç‚ºä¹‹å‰çš„ data_tw å’Œ data_two å¯èƒ½åŒ…å«ç„¡æ•ˆåˆ—
    # é€™è£¡é‡æ–°æŠ“å–æˆ–å¾å·²æœ‰çš„ DF æå–å¤ªæ…¢ï¼Œç›´æ¥ç”¨å·²ä¸‹è¼‰çš„ DF åˆä½µ
    
    # å»ºç«‹ä¸€å€‹æ–°çš„ Dict å­˜æ”¾æ•¸æ“š
    combined_dict = {}
    
    # å¾ data_tw æå–
    if not data_tw.empty:
        for t in data_tw.columns.levels[0]:
            if t in all_valid_yf_tickers:
                combined_dict[t] = data_tw[t]
                
    # å¾ data_two æå–
    if failed_codes and not data_two.empty:
        for t in data_two.columns.levels[0]:
            if t in all_valid_yf_tickers:
                combined_dict[t] = data_two[t]

    # å°‡ Dict è½‰å› MultiIndex DataFrame (é¡ä¼¼ yfinance åŸå§‹è¼¸å‡º)
    if combined_dict:
        final_data = pd.concat(combined_dict, axis=1, keys=combined_dict.keys())
    
    progress_bar.empty()
    return final_data, valid_tickers_map

def get_latest_snapshot_with_strategy(data, tickers, sector_map, ticker_map):
    results = []
    
    for code in tickers:
        try:
            # å–å¾—å°æ‡‰çš„ yfinance ticker (TW or TWO)
            yf_ticker = ticker_map.get(code)
            if not yf_ticker or yf_ticker not in data.columns:
                continue
                
            df = data[yf_ticker].copy()
            df = df.dropna(subset=['Close', 'Volume'])
            if df.empty or len(df) < 20: continue # è‡³å°‘è¦æœ‰ 20 å¤©æ•¸æ“š
            
            curr = df.iloc[-1]
            prev = df.iloc[-2]
            
            close = float(curr['Close'])
            prev_close = float(prev['Close'])
            change_pct = ((close - prev_close) / prev_close) * 100
            volume = float(curr['Volume'])
            prev_volume = float(prev['Volume'])
            
            # åŸºç¤æŒ‡æ¨™
            ma20 = df['Close'].rolling(20).mean().iloc[-1]
            ma50 = df['Close'].rolling(50).mean().iloc[-1] if len(df) >= 50 else ma20
            ma150 = df['Close'].rolling(150).mean().iloc[-1] if len(df) >= 150 else ma50
            ma200 = df['Close'].rolling(200).mean().iloc[-1] if len(df) >= 200 else ma50
            
            high_52w = df['High'].tail(252).max()
            low_52w = df['Low'].tail(252).min()
            
            avg_vol_20 = df['Volume'].iloc[-21:-1].mean() # æ’é™¤ä»Šæ—¥è¨ˆç®—éå»20æ—¥å‡é‡
            if pd.isna(avg_vol_20) or avg_vol_20 == 0: avg_vol_20 = 1
            
            r_vol = volume / avg_vol_20
            
            # --- ç­–ç•¥åˆ¤æ–· ---
            
            # 1. è¶…ç´šè¶¨å‹¢ (Super Trend)
            trend_score = 0
            if close > ma50 > ma150 > ma200: trend_score += 1
            if close > low_52w * 1.3: trend_score += 1
            if close > high_52w * 0.75: trend_score += 1
            is_super_trend = (trend_score == 3)
            
            # 2. å£è¢‹æ”¯é» (Pocket Pivot)
            is_pocket_pivot = False
            if change_pct > 0:
                last_10 = df.iloc[-11:-1]
                down_days = last_10[last_10['Close'] < last_10['Open']]
                if not down_days.empty:
                    if volume > down_days['Volume'].max(): is_pocket_pivot = True
                elif volume > last_10['Volume'].max(): is_pocket_pivot = True

            # 3. æ–°å¢ç­–ç•¥
            # A. æˆäº¤é‡æš´å¢: ä»Šæ—¥é‡ > 2.5å€å‡é‡ (ä¸”éæ¥µå°é‡è‚¡ï¼Œè¨­é–€æª» 500å¼µ)
            is_vol_explosion = (r_vol > 2.5) and (volume > 500000) # 500å¼µ = 500,000è‚¡
            
            # B. åƒ¹æ¼²é‡ç¸®: æ¼²å¹… > 0 ä¸” é‡ < æ˜¨æ—¥
            is_price_up_vol_down = (change_pct > 0) and (volume < prev_volume)
            
            # C. åƒ¹è·Œé‡å¢: æ¼²å¹… < 0 ä¸” é‡ > æ˜¨æ—¥
            is_price_down_vol_up = (change_pct < 0) and (volume > prev_volume)
            
            # D. åƒ¹è·Œé‡ç¸®: æ¼²å¹… < 0 ä¸” é‡ < æ˜¨æ—¥
            is_price_down_vol_down = (change_pct < 0) and (volume < prev_volume)
            
            volatility = ((curr['High'] - curr['Low']) / prev['Close']) * 100

            results.append({
                'Ticker': code, 
                'Sector': sector_map.get(code, ''),
                'Close': close, 
                'Change %': change_pct, 
                'Volume': volume,
                'RVol': r_vol, 
                '52W High': high_52w, 
                '52W Low': low_52w,
                'Super Trend': is_super_trend, 
                'Pocket Pivot': is_pocket_pivot,
                'Vol Explosion': is_vol_explosion,
                'Price Up Vol Down': is_price_up_vol_down,
                'Price Down Vol Up': is_price_down_vol_up,
                'Price Down Vol Down': is_price_down_vol_down,
                'Volatility': volatility
            })
        except Exception as e:
            continue
            
    return pd.DataFrame(results)

# ==========================================
# 3. è¦–è¦ºåŒ–
# ==========================================

def main():
    st.title("ğŸ“Š Taiwan Stock Pro Dashboard (å°è‚¡å°ˆæ¥­å„€è¡¨æ¿)")
    st.write(f"Last Update: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M')}")
    st.info("ç³»çµ±åŒ…å« 1000+ æª”å°è‚¡ï¼Œåˆæ¬¡è¼‰å…¥éœ€æ™‚ç´„ 1-2 åˆ†é˜ï¼Œè«‹è€å¿ƒç­‰å€™ã€‚")
    
    if st.button("ğŸ”„ Refresh Data"):
        st.cache_data.clear()
        st.rerun()

    with st.spinner('Downloading & Calculating...'):
        tickers, sector_map = parse_sector_data()
        full_data, ticker_map = get_market_data(tickers)
        
        if full_data.empty:
            st.error("Data download failed. Please try again.")
            return

        df_snapshot = get_latest_snapshot_with_strategy(full_data, tickers, sector_map, ticker_map)

    if df_snapshot.empty:
        st.warning("No valid data found.")
        return

    def fmt(df, val_col=None, fmt_str='{:.2f}'):
        d = df.copy()
        # æ ¼å¼åŒ–æ•¸å€¼
        d['Close'] = d['Close'].map('{:,.2f}'.format)
        d['Change %'] = d['Change %'].map('{:+.2f}%'.format)
        d['52W High'] = d['52W High'].map('{:,.2f}'.format)
        d['52W Low'] = d['52W Low'].map('{:,.2f}'.format)
        if 'Volume' in d.columns:
             d['Volume'] = (d['Volume']/1000).map('{:,.0f}å¼µ'.format)
             
        if val_col and val_col in d.columns and fmt_str:
            d[val_col] = d[val_col].map(fmt_str.format)
        return d

    # Helper to add tables
    def add_table(df, cols):
        return go.Figure(data=[go.Table(
            header=dict(values=cols, fill_color='navy', font=dict(color='white'), align='left'),
            cells=dict(values=[df[k] for k in df.columns], fill_color='lavender', align='left')
        )]).update_layout(height=300, margin=dict(l=0,r=0,t=0,b=0))

    # å®šç¾©è¡¨æ ¼æ¬„ä½
    cols_basic = ['Ticker', 'Sector', 'Close', 'Change %', 'Volume', 'RVol', 'Val']
    cols_adv = ['Ticker', 'Sector', 'Close', 'Change %', 'Volume', '52W High', '52W Low']

    # --- Part 1: å¼·å‹¢è‚¡ç¯©é¸ (ä¿ç•™åŸæœ‰) ---
    st.header("ä¸€ã€ å¼·å‹¢è‚¡ç¯©é¸ (Top Performers)")
    
    col1, col2 = st.columns(2)
    with col1:
        st.subheader("ğŸ”¥ è¶…ç´šè¶¨å‹¢è‚¡ (Super Trend)")
        df_super = df_snapshot[df_snapshot['Super Trend'] == True].sort_values('RVol', ascending=False).head(10)
        st.plotly_chart(add_table(fmt(df_super[cols_adv], 'RVol', '{:.2f}x'), cols_adv), use_container_width=True)
        
        st.subheader("ğŸš€ æ¼²å¹…æœ€å¼· Top 10")
        gainer_df = df_snapshot.sort_values('Change %', ascending=False).head(10)
        gainer_df['Val'] = gainer_df['RVol']
        st.plotly_chart(add_table(fmt(gainer_df[cols_basic], 'Val', '{:.2f}x'), cols_basic), use_container_width=True)

    with col2:
        st.subheader("ğŸ’ å£è¢‹æ”¯é»çˆ†é‡ (Pocket Pivot)")
        df_pocket = df_snapshot[df_snapshot['Pocket Pivot'] == True].sort_values('Change %', ascending=False).head(10)
        st.plotly_chart(add_table(fmt(df_pocket[cols_adv], 'RVol', '{:.2f}x'), cols_adv), use_container_width=True)

        st.subheader("ğŸ’§ è·Œå¹…æœ€é‡ Top 10")
        loser_df = df_snapshot.sort_values('Change %', ascending=True).head(10)
        loser_df['Val'] = loser_df['RVol']
        st.plotly_chart(add_table(fmt(loser_df[cols_basic], 'Val', '{:.2f}x'), cols_basic), use_container_width=True)

    # --- Part 2: é‡åƒ¹ç¯©é¸ç­–ç•¥ (æ–°å¢) ---
    st.header("äºŒã€ é‡åƒ¹ç¯©é¸ç­–ç•¥ (Volume & Price Analysis)")
    
    col3, col4 = st.columns(2)
    
    with col3:
        st.subheader("ğŸŒ‹ æˆäº¤é‡æš´å¢ (>2.5å€å‡é‡)")
        df_expl = df_snapshot[df_snapshot['Vol Explosion'] == True].sort_values('RVol', ascending=False).head(20)
        if not df_expl.empty:
            df_expl['Val'] = df_expl['RVol']
            st.plotly_chart(add_table(fmt(df_expl[cols_basic], 'Val', '{:.2f}x'), cols_basic), use_container_width=True)
        else:
            st.info("ä»Šæ—¥ç„¡ç¬¦åˆæ¢ä»¶å€‹è‚¡")

        st.subheader("ğŸ“‰ åƒ¹è·Œé‡å¢ (ææ…Œæ‹‹å”®?)")
        df_pdvu = df_snapshot[df_snapshot['Price Down Vol Up'] == True].sort_values('Change %', ascending=True).head(20)
        if not df_pdvu.empty:
             df_pdvu['Val'] = df_pdvu['RVol']
             st.plotly_chart(add_table(fmt(df_pdvu[cols_basic], 'Val', '{:.2f}x'), cols_basic), use_container_width=True)
        else:
            st.info("ä»Šæ—¥ç„¡ç¬¦åˆæ¢ä»¶å€‹è‚¡")

    with col4:
        st.subheader("ğŸ“ˆ åƒ¹æ¼²é‡ç¸® (æƒœå”®/èƒŒé›¢?)")
        df_puvd = df_snapshot[df_snapshot['Price Up Vol Down'] == True].sort_values('Change %', ascending=False).head(20)
        if not df_puvd.empty:
             df_puvd['Val'] = df_puvd['RVol']
             st.plotly_chart(add_table(fmt(df_puvd[cols_basic], 'Val', '{:.2f}x'), cols_basic), use_container_width=True)
        else:
            st.info("ä»Šæ—¥ç„¡ç¬¦åˆæ¢ä»¶å€‹è‚¡")

        st.subheader("â„ï¸ åƒ¹è·Œé‡ç¸® (é‡ç¸®å›æª”?)")
        df_pdvd = df_snapshot[df_snapshot['Price Down Vol Down'] == True].sort_values('Change %', ascending=True).head(20)
        if not df_pdvd.empty:
             df_pdvd['Val'] = df_pdvd['RVol']
             st.plotly_chart(add_table(fmt(df_pdvd[cols_basic], 'Val', '{:.2f}x'), cols_basic), use_container_width=True)
        else:
            st.info("ä»Šæ—¥ç„¡ç¬¦åˆæ¢ä»¶å€‹è‚¡")

if __name__ == "__main__":
    main()
